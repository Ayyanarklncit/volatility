<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title>Volatility Technology Preview User manual</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}


#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Volatility Technology Preview User manual</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_basic_usage">1. Basic Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_command_line_invocation">1.1. Command line Invocation</h3>
<div class="paragraph"><p>Volatility can be invoked from the command line. For example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    <img src="images/icons/callouts/1.png" alt="1" />        <img src="images/icons/callouts/2.png" alt="2" />                                                 <img src="images/icons/callouts/3.png" alt="3" />       <img src="images/icons/callouts/4.png" alt="4" />
$ vol.py --profile Win7SP0x64 --filename win7_trial_64bit.raw pslist --proc_reg DumpIt
  Offset (V)   Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                Exit
-------------- -------------------- ------ ------ ------ -------- ------ ------ -------------------- --------------------
0xfa8001016060 DumpIt.exe             2860   1652      2       42      1   True 2012-02-22 11:28:59  -</code></pre>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1" /></td><td>
The volatility program name (vol.py).
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2" /></td><td>
These are global options which are processed by the main volatility
executable (in this case --profile, --filename).
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3" /></td><td>
The name of the command plugin to run. To find all command available run the
info command or simply issue --help.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4" /></td><td>
These options are specific to the command. Each command can specify
additional options that will be used by it alone.
</td></tr>
</table></div>
<div class="paragraph"><p>Volatility is strict with the order in which commands are supplied. For example
it is not valid to provide the --proc_reg parameter before the pslist keyword
(since it is a command specific parameter). Similarly it is not legal to provide
the --filename parameter after the command name (pslist). This strictness allows
different modules to define the same command line option for their own needs and
avoids any command line option clashes between different plugins.</p></div>
<div class="paragraph"><p>This strictness can easily be observed when requesting help. Without a module
name, the help output simply lists those options processed by the main program
(i.e. global options). It also provides a list of available modules:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ vol.py --help
usage: vol.py [-h] [--pager PAGER]
              [--logging {debug,info,warning,critical,error}] [--debug]
              [-p PROFILE] [-f FILENAME] [--renderer RENDERER]
              [--plugin PLUGIN [PLUGIN ...]] [--output OUTPUT] [--overwrite]
              Plugin ...

optional arguments:
  -h, --help            show this help message and exit
  --pager PAGER         The pager to use when output is larger than a screen
                        full.
  --logging {debug,info,warning,critical,error}
                        Logging level to show messages.
  --debug               If set we break into the debugger on error conditions.
  -p PROFILE, --profile PROFILE
                        Name of the profile to load.
  -r RUN, --run RUN     Run this script before dropping into the interactive
                        shell.
  -f FILENAME, --filename FILENAME
                        The raw image to load.
  --renderer RENDERER   The renderer to use. e.g. (TextRenderer,
                        JsonRenderer).
  --plugin PLUGIN [PLUGIN ...]
                        Load user provided plugin bundle.
  --output OUTPUT       Write to this output file.
  --overwrite           Allow overwriting of output files.

subcommands:
  The following plugins can be selected.

  Plugin
    dis                 Disassemble the given address space.
    dt                  Print a symbol.
    dump                Hexdump an object or memory location.
    find_dtb            A scanner for DTB values.
    guess_profile       Guess the exact windows profile using heuristics.
    imagecopy           Copies a physical address space out as a raw DD image
    info                Print information about various subsystems.
    load_as             Load address spaces into the session if its not
                        already loaded.
    null                This plugin does absolutely nothing.
    peinfo              Print information about a PE binary.</code></pre>
</div></div>
<div class="paragraph"><p>Note that when not providing a profile, the list of subcommands only shows the
plugins which can be run without a profile. If you want to check the plugins
which can be run on the current image or on a specific profile, simply provide
the --profile or --filename option:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/images/win7_trial_64bit.raw --help

usage: vol.py [--pager PAGER] [--logging {debug,info,warning,critical,error}]
              [--debug] [-p PROFILE] [-r RUN] [-f FILENAME]
              [--renderer RENDERER] [--plugin PLUGIN [PLUGIN ...]]
              [--output OUTPUT] [-h] [--overwrite]
              Plugin ...

optional arguments:
...

subcommands:
  The following plugins can be selected.

  Plugin
    atoms               Print session and window station atom tables
    atomscan            Pool scanner for _RTL_ATOM_TABLE
    callbacks           Print system-wide notification routines.
    cmdscan             Extract command history by scanning for
                        _COMMAND_HISTORY
....</code></pre>
</div></div>
<div class="paragraph"><p>Once the module is provided, we see a per-module help output:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ vol.py --profile WinXPSP1x86 pslist --help
usage: vol.py pslist [-h] [--kdbg KDBG] [--eprocess EPROCESS [EPROCESS ...]]
                     [--phys_eprocess PHYS_EPROCESS [PHYS_EPROCESS ...]]
                     [--pid PID [PID ...]] [--proc_regex PROC_REGEX]

List processes for windows.

optional arguments:
  -h, --help            show this help message and exit
  --kdbg KDBG           Location of the KDBG structure.
  --eprocess EPROCESS [EPROCESS ...]
                        Kernel addresses of eprocess structs.
  --phys_eprocess PHYS_EPROCESS [PHYS_EPROCESS ...]
                        Physical addresses of eprocess structs.
  --pid PID [PID ...]   One or more pids of processes to select.
  --proc_regex PROC_REGEX
                        A regex to select a profile by name.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Volatility plugins provide a name by which they can be called. This name depends
on the currently specified profile. This allows the same name to be provided by
different plugins - for example, there is a linux pslist and a windows
pslist. Although both commands are called pslist, they may have slightly
different options.</p></div>
<div class="paragraph"><p>This is the reason you need to specify the --profile option even while issuing
the --help parameter. This is so that correct version of the pslist plugin be
chosen and the correct help printed out.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_interactive_session_invocation">1.2. Interactive Session Invocation.</h3>
<div class="paragraph"><p>When invoked without a command name, Volatility drops into the interactive
shell. This mode of operation is more efficient as many commands can be run
without needing to reinitialize the framework each time.</p></div>
<div class="paragraph"><p>This is what happens during initialization:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ vol.py --profile Win7SP0x64 --filename win7_trial_64bit.raw
Python 2.6.5 (r265:79063, Apr 16 2010, 13:57:41)
Type "copyright", "credits" or "license" for more information.

The Volatility Memory Forensic Framework technology preview (3.0_tp2).

This program is free software; you can redistribute it and/or modify it under
the terms of the GNU General Public License.

Win7SP0x64:win7_trial_64bit.raw 01:32:55&gt; print session               <img src="images/icons/callouts/1.png" alt="1" />
Volatility session Started on Sun Sep 23 01:32:57 2012.

Config:
 base_filename:  'win7_trial_64bit.raw'
 filename:  'win7_trial_64bit.raw'                                    <img src="images/icons/callouts/2.png" alt="2" />
 logging:  'INFO'
 overwrite:  False
 pager:  &lt;Set this to your favourite pager.&gt;
 paging_limit:  50
...

Win7SP0x64:win7_trial_64bit.raw 01:33:07&gt; plugins.[tab][tab]          <img src="images/icons/callouts/3.png" alt="3" />
plugins.atoms           plugins.dlldump         plugins.handles
plugins.atomscan        plugins.dlllist         plugins.hivedump
plugins.callbacks       plugins.driverirp       plugins.hivescan
plugins.clipboard       plugins.driverscan      plugins.imagecopy
....

Win7SP0x64:win7_trial_64bit.raw 01:34:57&gt; pslist proc_regex="DumpIt"  <img src="images/icons/callouts/4.png" alt="4" />
----------------------------------------&gt; pslist(proc_regex="DumpIt")
  Offset (V)   Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                Exit
-------------- -------------------- ------ ------ ------ -------- ------ ------ -------------------- --------------------
0xfa8001016060 DumpIt.exe             2860   1652      2       42      1   True 2012-02-22 11:28:59  -</code></pre>
</div></div>
<div class="colist arabic"><table>
<tr><td><img src="images/icons/callouts/1.png" alt="1" /></td><td>
A new session.Session() object is created. This holds all information about
the current running session.
</td></tr>
<tr><td><img src="images/icons/callouts/2.png" alt="2" /></td><td>
Global command line args are parsed into the session - so for example, the
--filename argument is parsed into session.filename.
</td></tr>
<tr><td><img src="images/icons/callouts/3.png" alt="3" /></td><td>
The is_active() method for all command plugins is called, and the names of
all active plugins are collected. For example, if we have a windows based
profile, WinPSList will return True for is_active() and will be considered
active.
</td></tr>
<tr><td><img src="images/icons/callouts/4.png" alt="4" /></td><td>
For all active commands, we create wrapper functions in the session object
and the namespace of the interactive shell. The wrapper will automatically set
up a TextRenderer, instantiate the plugin and call its render method with the
text renderer. For example, when the user types pslist() in the interactive UI,
we create a new TextRenderer, instantiate the WinPSList class and call its
render method.
</td></tr>
</table></div>
<div class="paragraph"><p>An external script can be execute when starting up using the --run command. This
script will be run with the full environment available to it (e.g. the session
object is available for read and write). Once the script has executed, the
program continues on to the interactive mode.</p></div>
<div class="paragraph"><p>This allows one to script a series of commands to be run. For example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>pslist()
psscan()
psxview()

# This will exit the program and skip the interactive shell.
sys.exit()</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="images/icons/note.png" alt="Note" />
</td>
<td class="content">
<div class="paragraph"><p>Recent versions of Volatility have a fairly reliable profile autodetection
system. This means that often the --profile parameter can be omitted - in that
case Volatility will just automatically select the most appropriate profile.</p></div>
<div class="paragraph"><p>If this autoselection does not work, it is still possible to override it by
using the --profile parameter. In the remainder of this document we explicitely
set the parameter in order to illustrate the type of image used.</p></div>
<div class="paragraph"><p>In the interactive shell you can see what profile was autoselected by examining
the prompt or printing session.profile.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_command_reference">2. Command Reference</h2>
<div class="sectionbody">
<div class="paragraph"><p>Many plugins operate on specific processes. These present a common set of
process selectors which are available through the command line. Note that
process selectors are consistently applied across many plugins and all work the
same way so its worth becoming familiar with them:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>  --eprocess EPROCESS [EPROCESS ...]
                        Kernel addresses of eprocess structs.
  --phys_eprocess PHYS_EPROCESS [PHYS_EPROCESS ...]
                        Physical addresses of eprocess structs.
  --pid PID [PID ...]   One or more pids of processes to select.
  --proc_regex PROC_REGEX
                        A regex to select a process by name.
  --eprocess_head EPROCESS_HEAD
                        Use this as the process head. If specified we do not
                        use kdbg.</code></pre>
</div></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
An list of eprocess addresses can be specified in both the physical or virtual
address spaces. For example you might get these addresses from psscan. The
eprocess list can be specified as hex integers.
</p>
</li>
<li>
<p>
pids can be specified as a list (either comma or space sperated) of integers
(either decimal or if preceeded with 0x hex).
</p>
</li>
<li>
<p>
A regex can be applied to the process name for process selection. This is
currently applied to the _EPROCESS.ImageFileName member.
</p>
</li>
</ol></div>
<div class="sect2">
<h3 id="_kdbgscan">2.1. kdbgscan</h3>
<div class="paragraph"><p>This plugin scans for the KDBGHeader signatures linked to Volatility profiles
and applies sanity checks to reduce false positives. Since the KDBG scanning
happens in the kernel address space, a valid DTB must be available (either
determined with find_dtb or provided). This plugin is useful to display an
overview of the KDBG header and the sanity checks performed on it.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py --profile VistaSP1x86 --file ~/images/vista_sp1_x86.raw --debug kdbgscan
**************************************************
Instantiating KDBG using: Kernel AS@0x122000 VistaSP1x86 (6.0.6001 32bit)
Offset (V)                    : 0x81afbc90
Offset (P)                    : 0x1afbc90
KDBG owner tag check          : True
Version64                     : 0x81afbc68 (Major: 15, Minor: 6001)
Service Pack (CmNtCSDVersion) : 1
Build string (NtBuildLab)     : 6001.18000.x86fre.longhorn_rtm.0
PsActiveProcessHead           : 0x81b11990 (40 processes)
PsLoadedModuleList            : 0x81b1bc70 (127 modules)
KernelBase                    : 0x81a04000 (Matches MZ: True)
Major (OptionalHeader)        : 6
Minor (OptionalHeader)        : 0
KPCR                          : 0x81afc800 (CPU 0)
KPCR                          : 0x803d1000 (CPU 1)</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_processes_and_dlls">3. Processes and DLLs</h2>
<div class="sectionbody">
<div class="paragraph"><p>Most of the following plugins examin processes and DLLs in process. You can
always apply the same filtering options to help target specific processes:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<code>--eprocess EPROCESS [EPROCESS ...]</code>
</dt>
<dd>
<p>
   Kernel addresses of eprocess structs. If this is specified we only show those
   processes. Note that you can provide more than one address here - either
   space or comma separated.
</p>
</dd>
<dt class="hdlist1">
<code>--phys_eprocess PHYS_EPROCESS [PHYS_EPROCESS ...]</code>
</dt>
<dd>
<p>
   Physical addresses of eprocess structs.
</p>
</dd>
<dt class="hdlist1">
<code>--pid PID [PID ...]</code>
</dt>
<dd>
<p>
   One or more pids of processes to select.
</p>
</dd>
<dt class="hdlist1">
<code>--proc_regex PROC_REGEX</code>
</dt>
<dd>
<p>
   A regex to select a process by name.
</p>
</dd>
</dl></div>
<div class="sect2">
<h3 id="_pslist">3.1. pslist</h3>
<div class="paragraph"><p>To list the processes of a system, use the pslist command. This walks the
doubly-linked list pointed to by PsActiveProcessHead and shows the offset,
process name, process ID, the parent process ID, number of threads, number of
handles, and date/time when the process started and exited. As of 2.1 it also
shows the Session ID and if the process is a Wow64 process (it uses a 32 bit
address space on a 64 bit kernel).</p></div>
<div class="paragraph"><p>This plugin does not detect hidden or unlinked processes (but
<a href="#psscan">[psscan]</a> can do that).</p></div>
<div class="paragraph"><p>If you see processes with 0 threads, 0 handles, and/or a non-empty exit time,
the process may not actually still be active. For more information, see The
Missing Active in PsActiveProcessHead. Below, you&#8217;ll notice regsvr32.exe has
terminated even though its still in the "active" list.</p></div>
<div class="paragraph"><p>Also note the two processes System and smss.exe will not have a Session ID,
because System starts before sessions are established and smss.exe is the
session manager itself.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 pslist
Volatile Systems Volatility Framework 2.1_alpha
Offset(V)          Name                    PID   PPID   Thds     Hnds   Sess  Wow64 Start                Exit
------------------ -------------------- ------ ------ ------ -------- ------ ------ -------------------- --------------------
0xfffffa80004b09e0 System                    4      0     78      489 ------      0 2012-02-22 19:58:20
0xfffffa8000ce97f0 smss.exe                208      4      2       29 ------      0 2012-02-22 19:58:20
0xfffffa8000c006c0 csrss.exe               296    288      9      385      0      0 2012-02-22 19:58:24
0xfffffa8000c92300 wininit.exe             332    288      3       74      0      0 2012-02-22 19:58:30
0xfffffa8000c06b30 csrss.exe               344    324      7      252      1      0 2012-02-22 19:58:30
0xfffffa8000c80b30 winlogon.exe            372    324      5      136      1      0 2012-02-22 19:58:31
0xfffffa8000c5eb30 services.exe            428    332      6      193      0      0 2012-02-22 19:58:32
0xfffffa80011c5700 lsass.exe               444    332      6      557      0      0 2012-02-22 19:58:32
0xfffffa8000ea31b0 lsm.exe                 452    332     10      133      0      0 2012-02-22 19:58:32
0xfffffa8001296b30 svchost.exe             568    428     10      352      0      0 2012-02-22 19:58:34
0xfffffa80012c3620 svchost.exe             628    428      6      247      0      0 2012-02-22 19:58:34
0xfffffa8001325950 sppsvc.exe              816    428      5      154      0      0 2012-02-22 19:58:41
0xfffffa80007b7960 svchost.exe             856    428     16      404      0      0 2012-02-22 19:58:43
0xfffffa80007bb750 svchost.exe             880    428     34     1118      0      0 2012-02-22 19:58:43
0xfffffa80007d09e0 svchost.exe             916    428     19      443      0      0 2012-02-22 19:58:43
0xfffffa8000c64840 svchost.exe             348    428     14      338      0      0 2012-02-22 20:02:07
0xfffffa8000c09630 svchost.exe             504    428     16      496      0      0 2012-02-22 20:02:07
0xfffffa8000e86690 spoolsv.exe            1076    428     12      271      0      0 2012-02-22 20:02:10
0xfffffa8000518b30 svchost.exe            1104    428     18      307      0      0 2012-02-22 20:02:10
0xfffffa800094d960 wlms.exe               1264    428      4       43      0      0 2012-02-22 20:02:11
0xfffffa8000995b30 svchost.exe            1736    428     12      200      0      0 2012-02-22 20:02:25
0xfffffa8000aa0b30 SearchIndexer.         1800    428     12      757      0      0 2012-02-22 20:02:26
0xfffffa8000aea630 taskhost.exe           1144    428      7      189      1      0 2012-02-22 20:02:41
0xfffffa8000eafb30 dwm.exe                1476    856      3       71      1      0 2012-02-22 20:02:41
0xfffffa80008f3420 explorer.exe           1652    840     21      760      1      0 2012-02-22 20:02:42
0xfffffa8000c9a630 regsvr32.exe           1180   1652      0 --------      1      0 2012-02-22 20:03:05  2012-02-22 20:03:08
0xfffffa8000a03b30 rundll32.exe           2016    568      3       67      1      0 2012-02-22 20:03:16
0xfffffa8000a4f630 svchost.exe            1432    428     12      350      0      0 2012-02-22 20:04:14
0xfffffa8000999780 iexplore.exe           1892   1652     19      688      1      1 2012-02-22 11:26:12
0xfffffa80010c9060 iexplore.exe           2820   1892     23      733      1      1 2012-02-22 11:26:15
0xfffffa8001016060 DumpIt.exe             2860   1652      2       42      1      1 2012-02-22 11:28:59
0xfffffa8000acab30 conhost.exe            2236    344      2       51      1      0 2012-02-22 11:28:59</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_pstree">3.2. pstree</h3>
<div class="paragraph"><p>To view the process listing in tree form, use the pstree command. This
enumerates processes using the same technique as pslist, so it will also not
show hidden or unlinked processes. Child process are indicated using indention
and periods. The --verbose option will cause the process name to be printed from several other locations.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ vol.py --profile VistaSP1x86 --file vista_sp1_x86.raw --debug pstree --verbose
Name                                        Pid   PPid   Thds   Hnds Time
---------------------------------------- ------ ------ ------ ------ --------------------
 0x8461BD90:csrss.exe                       444    432     10    469 2012-09-18 16:45:53
    cmd: C:\Windows\system32\csrss.exe ObjectDirectory=\Windows SharedSection=1024,12288,512 Windows=On SubSystemType=Windows ServerDll=basesrv,1 ServerDll=winsrv:UserServerDllInitialization,3 ServerDll=winsrv:ConServerDllInitialization,2 ProfileControl=Off MaxRequestThreads=16
    path: C:\Windows\system32\csrss.exe
    audit: \Device\HarddiskVolume1\Windows\System32\csrss.exe
 0x845C4020:wininit.exe                     492    432      3    102 2012-09-18 16:46:02
    cmd: wininit.exe
    path: C:\Windows\system32\wininit.exe
    audit: \Device\HarddiskVolume1\Windows\System32\wininit.exe
. 0x84A5CD90:services.exe                   568    492      7    213 2012-09-18 16:46:07
     cmd: C:\Windows\system32\services.exe
     path: C:\Windows\system32\services.exe
     audit: \Device\HarddiskVolume1\Windows\System32\services.exe
.. 0x83D89020:spoolsv.exe                  1560    568     18    301 2012-09-18 16:50:44
      cmd: C:\Windows\System32\spoolsv.exe
      path: C:\Windows\System32\spoolsv.exe
      audit: \Device\HarddiskVolume1\Windows\System32\spoolsv.exe</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_psscan">3.3. psscan</h3>
<div class="paragraph"><p>To enumerate processes using pool tag scanning, use the psscan command. This can
find processes that previously terminated (inactive) and processes that have
been hidden or unlinked by a rootkit.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ vol.py --profile VistaSP1x86 --file ~/images/vista_sp1_x86.raw psscan
  Offset   Offset(V)  Name                PID   PPID    PDB     Stat Time created         Time exited
---------- ---------- ---------------- ------ ------ ---------- ---- -------------------- --------------------
0x02da7a58 0x82da7a58 System                4      0 0x00122000 EP   2012-09-18 16:45:48
0x2ee8fac0 0x8aa32123 svchost.exe         724    572 0x2f0c8120      2012-09-18 23:43:02
0x2ee9dd90 ---------- svchost.exe        1140    572 0x2f0c8280      2012-09-18 23:43:23
0x2f05cd90 0x84a5cd90 services.exe        568    492 0x2f2b5080 EP   2012-09-18 16:46:07
0x2f062d90 0x84a62d90 lsm.exe             588    492 0x2f2b5100 EP   2012-09-18 16:46:07
0x2f092020 0x84a92020 lsass.exe           580    492 0x2f2b50e0 EP   2012-09-18 16:46:07
0x2f092c40 0x84a92c40 svchost.exe         736    568 0x2f2b5120 EP   2012-09-18 16:46:20
0x2f0e71c0 0x84ae71c0 svchost.exe        1144    568 0x2f2b5260 EP   2012-09-18 16:50:42
0x2f11e630 0x84b1e630 svchost.exe         796    568 0x2f2b5140 EP   2012-09-18 16:46:21
0x2f134220 0x84b34220 svchost.exe         884    568 0x2f2b5180 EP   2012-09-18 16:46:21
0x2f164500 0x84b64500 svchost.exe         924    568 0x2f2b51c0 EP   2012-09-18 16:46:22
0x2f170488 0x84b70488 audiodg.exe         956    924 0x2f2b5200 EP   2012-09-18 16:46:22
0x2f186738 0x84b86738 SLsvc.exe           984    568 0x2f2b5240 EP   2012-09-18 16:46:23
0x2f2272d0 0x848272d0 smss.exe            380      4 0x2f2b5020 EP   2012-09-18 16:45:48
0x2f3afd90 0x849afd90 winlogon.exe        528    476 0x2f2b5040 EP   2012-09-18 16:46:04
0x2f41bd90 0x8461bd90 csrss.exe           444    432 0x2f2b5060 EP   2012-09-18 16:45:53
0x2f7c3d90 0x845c3d90 csrss.exe           484    476 0x2f2b50a0 EP   2012-09-18 16:46:02
0x2f7c4020 0x845c4020 wininit.exe         492    432 0x2f2b50c0 EP   2012-09-18 16:46:02
0x2f7c5020 0x845c5020 svchost.exe         840    568 0x2f2b5160 EP   2012-09-18 16:46:21
0x2fa53598 0x84053598 cmd.exe            3184   3860 0x2f2b54a0 EP   2012-09-18 16:59:07
0x2fa57d90 0x84057d90 dwm.exe            3788    840 0x2f2b5420 EP   2012-09-18 16:58:15
0x2fa8b338 0x8408b338 iexplore.exe       3304   3132 0x2f2b54c0 EP   2012-09-18 16:59:19
0x2fa97270 0x84097270 sidebar.exe        2512   3860 0x2f2b5460 EP   2012-09-18 16:58:35
0x2faf78f0 0x840f78f0 taskeng.exe        3728    884 0x2f2b53c0 EP   2012-09-18 16:58:15
0x2fb00020 0x84100020 regsvr32.exe       3968   3860 0x2f2b5480 EP   2012-09-18 16:58:17  2012-09-18 16:58:20
0x2fb19b20 0x84119b20 MSASCui.exe         728   3860 0x2f2b5400 EP   2012-09-18 16:58:35
0x2fbd7d90 0x841d7d90 WmiPrvSE.exe       3140    736 0x2f2b53a0 EP   2012-09-18 16:54:54</code></pre>
</div></div>
<div class="paragraph"><p>If a process has previously terminated, the Time exited field will show the exit
time. The Stat field compares the output against the results from pslist. If the _EPROCESS offset is know from pslist an E will appear. If the Pid is known a P will appear.</p></div>
</div>
<div class="sect2">
<h3 id="_dlllist">3.4. dlllist</h3>
<div class="paragraph"><p>To display a process&#8217;s loaded DLLs, use the dlllist command. It walks the
doubly-linked list of LDR_DATA_TABLE_ENTRY structures which is pointed to by the
PEB&#8217;s InLoadOrderModuleList. DLLs are automatically added to this list when a
process calls LoadLibrary (or some derivative such as LdrLoadDll) and they
aren&#8217;t removed until FreeLibrary is called and the reference count reaches zero.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 dlllist
************************************************************************
wininit.exe pid:    332
Command line : wininit.exe

Base                             Size Path
------------------ ------------------ ----
0x00000000ff530000            0x23000 C:\Windows\system32\wininit.exe
0x0000000076d40000           0x1ab000 C:\Windows\SYSTEM32\ntdll.dll
0x0000000076b20000           0x11f000 C:\Windows\system32\kernel32.dll
0x000007fefcd50000            0x6b000 C:\Windows\system32\KERNELBASE.dll
0x0000000076c40000            0xfa000 C:\Windows\system32\USER32.dll
0x000007fefd7c0000            0x67000 C:\Windows\system32\GDI32.dll
0x000007fefe190000             0xe000 C:\Windows\system32\LPK.dll
0x000007fefef80000            0xca000 C:\Windows\system32\USP10.dll
0x000007fefd860000            0x9f000 C:\Windows\system32\msvcrt.dll
...</code></pre>
</div></div>
<div class="paragraph"><p>To display the DLLs for a process that is hidden or unlinked by a rootkit, first
use the psscan to get the physical or virtual offset of the EPROCESS object and
supply it with --eprocess or --phys_eprocess option.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py --profile VistaSP1x86 --file ~/images/vista_sp1_x86.raw dlllist --eprocess 0x84053598
************************************************************************
cmd.exe pid: 3184
Command line : "C:\Windows\System32\cmd.exe"
Service Pack 1

   Base       Size    Path
---------- ---------- ----
0x4a090000    0x50000 C:\Windows\System32\cmd.exe
0x77ed0000   0x127000 C:\Windows\system32\ntdll.dll
0x76620000    0xdb000 C:\Windows\system32\kernel32.dll
0x76710000    0xc6000 C:\Windows\system32\ADVAPI32.dll
0x76b00000    0xc3000 C:\Windows\system32\RPCRT4.dll
0x76f50000    0xaa000 C:\Windows\system32\msvcrt.dll
0x76420000    0x2c000 C:\Windows\system32\apphelp.dll</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_dlldump">3.5. dlldump</h3>
<div class="paragraph"><p>To extract a DLL from a process&#8217;s memory space and dump it to disk for analysis,
use the dlldump command. The syntax is nearly the same as what we&#8217;ve shown for
dlllist above. You can:</p></div>
<div class="ulist"><ul>
<li>
<p>
Dump all DLLs from all processes
</p>
</li>
<li>
<p>
Dump all DLLs from a specific process (with the usual process selectors like
  --pid, --eprocess etc)
</p>
</li>
<li>
<p>
Dump one or more DLLs that match a regular expression (--regex=REGEX), case
  sensitive or not (--ignore-case) To specify an output directory, use
  --dump-dir=DIR or -d DIR.
</p>
</li>
</ul></div>
<div class="paragraph"><p>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 dlldump -D dlls/</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Dumping sechost.dll, Process: lsass.exe, Base: 7fefd830000 output: module.444.173c5700.7fefd830000.dll
Dumping cryptbase.dll, Process: lsass.exe, Base: 7fefcb80000 output: module.444.173c5700.7fefcb80000.dll
Cannot dump lsass.exe@pstorsvc.dll at 7fef71e0000
Dumping USP10.dll, Process: lsass.exe, Base: 7fefef80000 output: module.444.173c5700.7fefef80000.dll
Dumping LPK.dll, Process: lsass.exe, Base: 7fefe190000 output: module.444.173c5700.7fefe190000.dll
Cannot dump lsass.exe@WINSTA.dll at 7fefcc40000
Dumping GDI32.dll, Process: lsass.exe, Base: 7fefd7c0000 output: module.444.173c5700.7fefd7c0000.dll
Dumping DNSAPI.dll, Process: lsass.exe, Base: 7fefc270000 output: module.444.173c5700.7fefc270000.dll
Dumping Secur32.dll, Process: lsass.exe, Base: 7fefc5d0000 output: module.444.173c5700.7fefc5d0000.dll
Dumping SAMSRV.dll, Process: lsass.exe, Base: 7fefc7e0000 output: module.444.173c5700.7fefc7e0000.dll
Dumping KERNELBASE.dll, Process: lsass.exe, Base: 7fefcd50000 output: module.444.173c5700.7fefcd50000.dll</code></pre>
</div></div>
<div class="paragraph"><p>If the extraction fails, as it did for a few DLLs above, it probably means that
some of the memory pages in that DLL were not memory resident (due to
paging). In particular, this is a problem if the first page containing the PE
header and thus the PE section mappings is not available. In these cases you can
still extract the memory segment using the <a href="#vaddump">[vaddump]</a> command,
but you&#8217;ll need to manually rebuild the PE header and fixup the sections as
described in Recovering CoreFlood Binaries with Volatility.</p></div>
</div>
<div class="sect2">
<h3 id="_pedump">3.6. pedump</h3>
<div class="paragraph"><p>This module is a generic PE dumper used to dump a PE file from memory. All we
need is the address space where the PE file lives, and the base of the
image. The address space can be selected to be any process using the usual
process selection directives (i.e. --pid, --eprocess etc).</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The address of the image base (dos header) can be specified using --image-base.
</p>
</li>
<li>
<p>
The file name to write is specified using --output.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You can use many other plugins to find the eprocess, pid or image base
(e.g. <a href="#dlllist">[dlllist]</a>, <a href="#psscan">[psscan]</a>). For example (this is equivalent to the dlldump
plugin):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$python vol.py -f ~/images/win7_trial_64bit.raw --profile=Win7SP0x64 dlllist --pid 2860
************************************************************************
DumpIt.exe pid: 2860
Command line : "C:\Users\testing\AppData\Local\Temp\Temp1_DumpIt.zip\DumpIt.exe"
Note: use ldrmodules for listing DLLs in Wow64 processes


     Base           Size      Path
-------------- -------------- ----
0x0000010c0000        0x35000 C:\Users\testing\AppData\Local\Temp\Temp1_DumpIt.zip\DumpIt.exe
0x000076d40000       0x1ab000 C:\Windows\SYSTEM32\ntdll.dll
0x0000748d0000        0x3f000 C:\Windows\SYSTEM32\wow64.dll
0x000074870000        0x5c000 C:\Windows\SYSTEM32\wow64win.dll
0x000074940000         0x8000 C:\Windows\SYSTEM32\wow64cpu.dll
$ python vol.py -f ~/images/win7_trial_64bit.raw --profile=Win7SP0x64 --debug pedump --output "/tmp/foo.dll" --pid 2860 --image-base 0x000076d40000
Dumping PE File at image_base 0x76d40000 to /tmp/foo.dll
Done!</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_handles">3.7. handles</h3>
<div class="paragraph"><p>To display the open handles in a process, use the handles command. This applies
to files, registry keys, mutexes, named pipes, events, window stations,
desktops, threads, and all other types of securable executive objects.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 handles
Volatile Systems Volatility Framework 2.1_alpha
Offset(V)             Pid             Handle             Access Type             Details
------------------ ------ ------------------ ------------------ ---------------- -------
0xfffffa80004b09e0      4                0x4           0x1fffff Process          System(4)
0xfffff8a0000821a0      4               0x10            0x2001f Key              MACHINE\SYSTEM\CONTROLSET001\CONTROL\PRODUCTOPTIONS
0xfffff8a00007e040      4               0x14            0xf003f Key              MACHINE\SYSTEM\CONTROLSET001\CONTROL\SESSION MANAGER\MEMORY MANAGEMENT\PREFETCHPARAMETERS
0xfffff8a000081fa0      4               0x18            0x2001f Key              MACHINE\SYSTEM\SETUP
0xfffffa8000546990      4               0x1c           0x1f0001 ALPC Port        PowerMonitorPort
0xfffffa800054d070      4               0x20           0x1f0001 ALPC Port        PowerPort
0xfffff8a0000676a0      4               0x24            0x20019 Key              MACHINE\HARDWARE\DESCRIPTION\SYSTEM\MULTIFUNCTIONADAPTER
0xfffffa8000625460      4               0x28           0x1fffff Thread           TID 160 PID 4
0xfffff8a00007f400      4               0x2c            0xf003f Key              MACHINE\SYSTEM\CONTROLSET001
0xfffff8a00007f200      4               0x30            0xf003f Key              MACHINE\SYSTEM\CONTROLSET001\ENUM
0xfffff8a000080d10      4               0x34            0xf003f Key              MACHINE\SYSTEM\CONTROLSET001\CONTROL\CLASS
0xfffff8a00007f500      4               0x38            0xf003f Key              MACHINE\SYSTEM\CONTROLSET001\SERVICES
0xfffff8a0001cd990      4               0x3c                0xe Token
0xfffff8a00007bfa0      4               0x40            0x20019 Key              MACHINE\SYSTEM\CONTROLSET001\CONTROL\WMI\SECURITY
0xfffffa8000cd52b0      4               0x44           0x120116 File             \Device\Mup
0xfffffa8000ce97f0      4               0x48               0x2a Process          smss.exe(208)
0xfffffa8000df16f0      4               0x4c           0x120089 File             \Device\HarddiskVolume2\Windows\System32\en-US\win32k.sys.mui
0xfffffa8000de37f0      4               0x50           0x12019f File             \Device\clfsTxfLog
0xfffff8a000952fa0      4               0x54            0x2001f Key              MACHINE\SYSTEM\CONTROLSET001\CONTROL\VIDEO\{6A8FC9DC-A76B-47FC-A703-17800182E1CE}\0000\VOLATILESETTINGS
0xfffffa800078da20      4               0x58           0x12019f File             \Device\Tcp
0xfffff8a002e17610      4               0x5c                0x9 Key              MACHINE\SOFTWARE\MICROSOFT\WINDOWS NT\CURRENTVERSION\IMAGE FILE EXECUTION OPTIONS
0xfffff8a0008f7b00      4               0x60               0x10 Key              MACHINE\SYSTEM\CONTROLSET001\CONTROL\LSA
0xfffffa8000da2870      4               0x64           0x100001 File             \Device\KsecDD
0xfffffa8000da3040      4               0x68                0x0 Thread           TID 228 PID 4</code></pre>
</div></div>
<div class="paragraph"><p>The usual process selection flags are also available. You can also filter by
object type using -t or --object-type=OBJECTTYPE. For example to only display
handles to process and file objects for pid 296, do the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ vol.py -f ~/images/win7_trial_64bit.raw --profile=Win7SP0x64 handles --pid 296 -t Process File
  Offset (V)      Pid     Handle         Access     Type             Details
-------------- ------ -------------- -------------- ---------------- -------
0xfa8000c06610    296            0x8       0x100020 File             \Device\HarddiskVolume2\Windows\System32
0xfa8000bc44f0    296           0x38       0x120089 File             \Device\HarddiskVolume2\Windows\System32\en-US\csrss.exe.mui
0xfa8000e67da0    296           0x50       0x120089 File             \Device\HarddiskVolume2\Windows\System32\en-US\winsrv.dll.mui
0xfa8000c92300    296           0x54       0x1fffff Process          wininit.exe(332)
0xfa8000c5eb30    296           0xc4       0x1fffff Process          services.exe(428)
0xfa80011c5700    296           0xd4       0x1fffff Process          lsass.exe(444)
0xfa80011c3dd0    296           0xdc       0x100001 File             \Device\KsecDD</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_getsids">3.8. getsids</h3>
<div class="paragraph"><p>To view the SIDs (Security Identifiers) associated with a process, use the
getsids command. Among other things, this can help you identify processes which
have maliciously escalated privileges.</p></div>
<div class="paragraph"><p>For more information, see BDG&#8217;s Linking Processes To Users.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 getsids
Volatile Systems Volatility Framework 2.1_alpha
System (4): S-1-5-18 (Local System)
System (4): S-1-5-32-544 (Administrators)
System (4): S-1-1-0 (Everyone)
System (4): S-1-5-11 (Authenticated Users)
System (4): S-1-16-16384 (System Mandatory Level)
smss.exe (208): S-1-5-18 (Local System)
smss.exe (208): S-1-5-32-544 (Administrators)
smss.exe (208): S-1-1-0 (Everyone)
smss.exe (208): S-1-5-11 (Authenticated Users)
smss.exe (208): S-1-16-16384 (System Mandatory Level)</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_cmdscan">3.9. cmdscan</h3>
<div class="paragraph"><p>The cmdscan plugin searches the memory of csrss.exe on XP/2003/Vista/2008 and
conhost.exe on Windows 7 for commands that attackers entered through a console
shell (cmd.exe). This is one of the most powerful commands you can use to gain
visibility into an attackers actions on a victim system, whether they opened
cmd.exe through an RDP session or proxied input/output to a command shell from a
networked backdoor.</p></div>
<div class="paragraph"><p>This plugin finds structures known as COMMAND_HISTORY by looking for a known
constant value (MaxHistory) and then applying sanity checks. It is important to
note that the MaxHistory value can be changed by right clicking in the top left
of a cmd.exe window and going to Properties. The value can also be changed for
all consoles opened by a given user by modifying the registry key
HKCU\Console\HistoryBufferSize. The default is 50 on Windows systems, meaning
the most recent 50 commands are saved. You can tweak it if needed by using the
--max_history=NUMBER parameter.</p></div>
<div class="paragraph"><p>The structures used by this plugin are not public (i.e. Microsoft does not
produce PDBs for them), thus they&#8217;re not available in WinDBG or any other
forensic framework. They were reverse engineered by Michael Ligh from the
conhost.exe and winsrv.dll binaries.</p></div>
<div class="paragraph"><p>In addition to the commands entered into a shell, this plugin shows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The name of the console host process (csrss.exe or conhost.exe)
</p>
</li>
<li>
<p>
The name of the application using the console (whatever process is using cmd.exe)
</p>
</li>
<li>
<p>
The location of the command history buffers, including the current buffer
  count, last added command, and last displayed command
</p>
</li>
<li>
<p>
The application process handle
</p>
</li>
</ol></div>
<div class="paragraph"><p>Due to the scanning technique this plugin uses, it has the capability to find
commands from both active and closed consoles.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f VistaSP2x64.vmem --profile=VistaSP2x64 cmdscan
**************************************************
CommandProcess: csrss.exe Pid: 528
CommandHistory: 0x135ec00 Application: cmd.exe Flags: Allocated, Reset
CommandCount: 18 LastAdded: 17 LastDisplayed: 17
FirstCommand: 0 CommandCountMax: 50
ProcessHandle: 0x330
Cmd #0 @ 0x135ef10: cd \
Cmd #1 @ 0x135ef50: cd de
Cmd #2 @ 0x135ef70: cd PerfLogs
Cmd #3 @ 0x135ef90: cd ..
Cmd #4 @ 0x5c78b90: cd "Program Files"
Cmd #5 @ 0x135fae0: cd "Debugging Tools for Windows (x64)"
Cmd #6 @ 0x135efb0: livekd -w
Cmd #7 @ 0x135f010: windbg
Cmd #8 @ 0x135efd0: cd \
Cmd #9 @ 0x135fd20: rundll32 c:\apphelp.dll,ExportFunc
Cmd #10 @ 0x5c8bdb0: rundll32 c:\windows_apphelp.dll,ExportFunc
Cmd #11 @ 0x5c8be10: rundll32 c:\windows_apphelp.dll
Cmd #12 @ 0x135ee30: rundll32 c:\windows_apphelp.dll,Test
Cmd #13 @ 0x135fd70: cd "Program Files"
Cmd #14 @ 0x5c8b9e0: dir
Cmd #15 @ 0x5c8be60: cd "Debugging Tools for Windows (x64)"
Cmd #16 @ 0x5c8ba00: dir
Cmd #17 @ 0x135eff0: livekd -w</code></pre>
</div></div>
<div class="paragraph"><p>For background information, see Richard Stevens and Eoghan Casey&#8217;s Extracting
Windows Cmd Line Details from Physical Memory.</p></div>
</div>
<div class="sect2">
<h3 id="_consoles">3.10. consoles</h3>
<div class="paragraph"><p>Similar to <a href="#cmdscan">[cmdscan]</a> the consoles plugin finds commands that attackers typed
into cmd.exe or executed via backdoors. However, instead of scanning for
COMMAND_HISTORY, this plugin scans for CONSOLE_INFORMATION. The major advantage
to this plugin is it not only prints the commands attackers typed, but it
collects the entire screen buffer (input and output). For instance, instead of
just seeing "dir", you&#8217;ll see exactly what the attacker saw, including all files
and directories listed by the "dir" command.</p></div>
<div class="paragraph"><p>Additionally, this plugin prints the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The original console window title and current console window title.
</p>
</li>
<li>
<p>
The name and pid of attached processes (walks a LIST_ENTRY to enumerate all of
  them if more than one)
</p>
</li>
<li>
<p>
Any aliases associated with the commands executed. For example, attackers can
  register an alias such that typing "hello" actually executes "cd system".
</p>
</li>
<li>
<p>
The screen coordinates of the cmd.exe console.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Here&#8217;s an example of the consoles command:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   $ python vol.py -f win7.raw --profile Win7SP1x64 consoles
   **************************************************
   ConsoleProcess: conhost.exe Pid: 2520
   Console: 0xff886200 CommandHistorySize: 50
   HistoryBufferCount: 2 HistoryBufferMax: 4
   OriginalTitle: Command Prompt
   Title: Administrator: Command Prompt - winpmem-1.1.exe  win7.raw
   AttachedProcess: winpmem-1.1.ex Pid: 2744 Handle: 0x88
   AttachedProcess: cmd.exe Pid: 2512 Handle: 0x5c
   ----
   CommandHistory: 0x25ee10 Application: winpmem-1.1.exe Flags: Allocated
   CommandCount: 0 LastAdded: -1 LastDisplayed: -1
   FirstCommand: 0 CommandCountMax: 50
   ProcessHandle: 0x88
   ----
   CommandHistory: 0x25eae0 Application: cmd.exe Flags: Allocated, Reset
   CommandCount: 3 LastAdded: 2 LastDisplayed: 2
   FirstCommand: 0 CommandCountMax: 50
   ProcessHandle: 0x5c
   Cmd #0 at 0x234ea0: cd \Users\a\Desktop
   Cmd #1 at 0x25d3a0: dir
   Cmd #2 at 0x25b390: winpmem-1.1.exe win7.raw
   ----
   Screen 0x240f80 X:80 Y:300
   Dump:
   Microsoft Windows [Version 6.1.7600]
   Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

   C:\Windows\system32&gt;
   C:\Windows\system32&gt;cd \Users\a\Desktop

   C:\Users\a\Desktop&gt;dir
    Volume in drive C has no label.
    Volume Serial Number is 369C-4D0B

    Directory of C:\Users\a\Desktop

   10/01/2012  07:00 AM    &lt;DIR&gt;          .
   10/01/2012  07:00 AM    &lt;DIR&gt;          ..
   10/01/2012  07:00 AM    &lt;DIR&gt;          .ipython
   07/13/2009  09:54 PM             1,280 Command Prompt.lnk
   10/01/2012  07:00 AM             1,086 Console - Shortcut.lnk
   10/01/2012  08:19 AM         7,896,543 vol.exe
   08/05/2012  12:56 PM         8,125,473 Volatility-2.1RC3.exe
   09/28/2012  05:32 AM           103,936 winpmem-1.1.exe
   09/28/2012  04:47 AM            92,160 winpmem_1.1-write.exe
                  6 File(s)     16,220,478 bytes
                  3 Dir(s)   3,702,800,384 bytes free

   C:\Users\a\Desktop&gt;winpmem-1.1.exe win7.raw
   Will write to win7.raw
   CR3: 0x0000187000
    2 memory ranges:
   Start 0x00001000 - Length 0x0009E000
   Start 0x00100000 - Length 0x2C9F0000
   Padding from 0x00000000 to 0x00001000
   .Reading from 0x00001000 to 0x0009F000
   .Padding from 0x0009F000 to 0x00100000
   .Reading from 0x00100000 to 0x2CAF0000</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_procinfo">3.11. procinfo</h3>
<div class="paragraph"><p>To display infomration about a specific process use the procinfo plugin. This
plugin shows information such as environment variables and the pe header
structures (i.e. number of sections, import and export directories etc). The
usual process selectors may be used.</p></div>
<div class="paragraph"><p>Typically this will show the number of CPUs installed and the hardware
architecture (though the <a href="#kdbgscan">[kdbgscan]</a> output is a much more reliable source),
the process&#8217;s current directory, temporary directory, session name, computer
name, user name, and various other interesting artifacts.</p></div>
<div class="paragraph"><p>Additionally if version information is accessible for the main executable it
will be displayed. Version information is stored in a resource section of the PE
file. Often however, the resource section is not fully mapped in.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ vol.py -f ~/images/win7_trial_64bit.raw --profile=Win7SP0x64 procinfo  --pid 296
************************************************************************
Pid: 296 csrss.exe

Process Environment
   ComSpec=C:\Windows\system32\cmd.exe
   FP_NO_HOST_CHECK=NO
   NUMBER_OF_PROCESSORS=1
   OS=Windows_NT
   Path=C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\
   PATHEXT=.COM;.EXE;.BAT;.CMD;.VBS;.VBE;.JS;.JSE;.WSF;.WSH;.MSC
   PROCESSOR_ARCHITECTURE=AMD64
   PROCESSOR_IDENTIFIER=Intel64 Family 6 Model 2 Stepping 3, GenuineIntel
   PROCESSOR_LEVEL=6
   PROCESSOR_REVISION=0203
   PSModulePath=C:\Windows\system32\WindowsPowerShell\v1.0\Modules\
   SystemDrive=C:
   SystemRoot=C:\Windows
   TEMP=C:\Windows\TEMP

PE Infomation
Machine              TimeDateStamp
-------------------- -------------
Machine              IMAGE_FILE_MACHINE_AMD64
TimeDateStamp        2009-07-13 23:19:49 UTC+0000
Characteristics      IMAGE_FILE_EXECUTABLE_IMAGE, IMAGE_FILE_LARGE_ADDRESS_AWARE

Sections (Relative to 0x49700000):
Perm Name          VMA            Size
---- -------- -------------- --------------
xr-  .text    0x000000001000 0x000000000c00
-rw  .data    0x000000002000 0x000000000200
-r-  .pdata   0x000000003000 0x000000000200
-r-  .rsrc    0x000000004000 0x000000000800
-r-  .reloc   0x000000005000 0x000000000200

Data Directories:
-                                             VMA            Size
---------------------------------------- -------------- --------------
IMAGE_DIRECTORY_ENTRY_EXPORT             0x000000000000 0x000000000000
IMAGE_DIRECTORY_ENTRY_IMPORT             0x0000497017c4 0x00000000003c
IMAGE_DIRECTORY_ENTRY_RESOURCE           0x000049704000 0x0000000007f8
IMAGE_DIRECTORY_ENTRY_EXCEPTION          0x000049703000 0x00000000003c
IMAGE_DIRECTORY_ENTRY_SECURITY           0x000000000000 0x000000000000
IMAGE_DIRECTORY_ENTRY_BASERELOC          0x000049705000 0x00000000000c
IMAGE_DIRECTORY_ENTRY_DEBUG              0x0000497010a0 0x00000000001c</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_memmap">3.12. memmap</h3>
<div class="paragraph"><p>The memmap command shows you exactly which pages are memory resident, given a
specific process DTB (or kernel DTB if you use this plugin on the Idle or System
process). It shows you the virtual address of the page, the corresponding
physical offset of the page, and the size of the page. The map information
generated by this plugin comes from the underlying address space&#8217;s
get_available_addresses method.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 memmap -p 4
Volatile Systems Volatility Framework 2.1_alpha
System pid:      4
Virtual            Physical                         Size     DumpFileOffset
------------------ ------------------ ------------------ ------------------
0x0000000000050000 0x0000000000cbc000             0x1000                0x0
0x0000000000051000 0x0000000015ec6000             0x1000             0x1000
0x0000000000052000 0x000000000f5e7000             0x1000             0x2000
0x0000000000053000 0x0000000005e28000             0x1000             0x3000
0x0000000000054000 0x0000000008b29000             0x1000             0x4000
0x0000000000055000 0x00000000155b8000             0x1000             0x5000
0x0000000000056000 0x000000000926e000             0x1000             0x6000
0x0000000000057000 0x0000000002dac000             0x1000             0x7000
0x0000000000058000 0x00000000162ed000             0x1000             0x8000</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_procexedump">3.13. procexedump</h3>
<div class="paragraph"><p>To dump a process&#8217;s executable (not including the slack space), use the
procexedump command. The syntax is identical to procmemdump.</p></div>
<div class="paragraph"><p>The usual process selection selectors apply.</p></div>
</div>
<div class="sect2">
<h3 id="_vadinfo">3.14. vadinfo</h3>
<div class="paragraph"><p>The vadinfo command displays extended information about a process&#8217;s VAD
nodes. In particular, it shows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
The address of the MMVAD structure in kernel memory
</p>
</li>
<li>
<p>
The starting and ending virtual addresses in process memory that the MMVAD structure pertains to
</p>
</li>
<li>
<p>
The VAD Tag
</p>
</li>
<li>
<p>
The VAD flags, control flags, etc
</p>
</li>
<li>
<p>
The name of the memory mapped file (if one exists)
</p>
</li>
<li>
<p>
The memory protection constant (permissions). Note there is a difference
  between the original protection and current protection. The original
  protection is derived from the flProtect parameter to VirtualAlloc. For
  example you can reserve memory (MEM_RESERVE) with protection PAGE_NOACCESS
  (original protection). Later, you can call VirtualAlloc again to commit
  (MEM_COMMIT) and specify PAGE_READWRITE (becomes current protection). The
  vadinfo command shows the original protection only. Thus, just because you see
  PAGE_NOACCESS here, it doesn&#8217;t mean code in the region cannot be read,
  written, or executed.
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 vadinfo -p 296
Volatile Systems Volatility Framework 2.1_alpha
************************************************************************
Pid:    296
VAD node @ 0xfffffa8000c00620 Start 0x000000007f0e0000 End 0x000000007ffdffff Tag VadS
Flags: PrivateMemory: 1, Protection: 1
Protection: PAGE_READONLY
Vad Type: VadNone

...

VAD node @ 0xfffffa8000c04ce0 Start 0x000007fefcd00000 End 0x000007fefcd10fff Tag Vad
Flags: CommitCharge: 2, Protection: 7, VadType: 2
Protection: PAGE_EXECUTE_WRITECOPY
Vad Type: VadImageMap
ControlArea @fffffa8000c04d70 Segment fffff8a000c45c10
Dereference list: Flink 00000000, Blink 00000000
NumberOfSectionReferences:          0 NumberOfPfnReferences:          13
NumberOfMappedViews:                2 NumberOfUserReferences:          2
WaitingForDeletion Event:  00000000
Control Flags: Accessed: 1, File: 1, Image: 1
FileObject @fffffa8000c074d0, Name: \Windows\System32\basesrv.dll
First prototype PTE: fffff8a000c45c58 Last contiguous PTE: fffffffffffffffc
Flags2: Inherit: 1

...</code></pre>
</div></div>
<div class="paragraph"><p>For more information on the VAD, see BDG&#8217;s The VAD Tree: A Process-Eye View of
Physical Memory.</p></div>
</div>
<div class="sect2">
<h3 id="_vadwalk">3.15. vadwalk</h3>
<div class="paragraph"><p>To inspect a process&#8217;s VAD nodes in table form, use the vadwalk command.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 vadwalk -p 296
Volatile Systems Volatility Framework 2.1_alpha
************************************************************************
Pid:    296
Address            Parent             Left               Right              Start              End                Tag
------------------ ------------------ ------------------ ------------------ ------------------ ------------------ ----
0xfffffa8000c00620 0x0000000000000000 0xfffffa8000deaa40 0xfffffa8000c043d0 0x000000007f0e0000 0x000000007ffdffff VadS
0xfffffa8000deaa40 0xfffffa8000c00620 0xfffffa8000bc4660 0xfffffa80011b8d80 0x0000000000ae0000 0x0000000000b1ffff VadS
0xfffffa8000bc4660 0xfffffa8000deaa40 0xfffffa8000c04260 0xfffffa8000c91010 0x00000000004d0000 0x0000000000650fff Vadm
0xfffffa8000c04260 0xfffffa8000bc4660 0xfffffa8000c82010 0xfffffa80012acce0 0x00000000002a0000 0x000000000039ffff VadS
0xfffffa8000c82010 0xfffffa8000c04260 0xfffffa8000cbce80 0xfffffa8000c00330 0x00000000001f0000 0x00000000001f0fff Vadm
0xfffffa8000cbce80 0xfffffa8000c82010 0xfffffa8000bc4790 0xfffffa8000d9bb80 0x0000000000180000 0x0000000000181fff Vad
0xfffffa8000bc4790 0xfffffa8000cbce80 0xfffffa8000c00380 0xfffffa8000e673a0 0x0000000000100000 0x0000000000166fff Vad
0xfffffa8000c00380 0xfffffa8000bc4790 0x0000000000000000 0x0000000000000000 0x0000000000000000 0x00000000000fffff VadS
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_vadtree">3.16. vadtree</h3>
<div class="paragraph"><p>To display the VAD nodes in a visual tree form, use the vadtree command.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 vadtree -p 296
Volatile Systems Volatility Framework 2.1_alpha
************************************************************************
Pid:    296
 0x000000007f0e0000 - 0x000000007ffdffff
  0x0000000000ae0000 - 0x0000000000b1ffff
   0x00000000004d0000 - 0x0000000000650fff
    0x00000000002a0000 - 0x000000000039ffff
     0x00000000001f0000 - 0x00000000001f0fff
      0x0000000000180000 - 0x0000000000181fff
       0x0000000000100000 - 0x0000000000166fff
        0x0000000000000000 - 0x00000000000fffff
        0x0000000000170000 - 0x0000000000170fff
       0x00000000001a0000 - 0x00000000001a1fff
        0x0000000000190000 - 0x0000000000190fff
        0x00000000001b0000 - 0x00000000001effff
      0x0000000000240000 - 0x000000000024ffff
       0x0000000000210000 - 0x0000000000216fff
        0x0000000000200000 - 0x000000000020ffff
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_vaddump">3.17. vaddump</h3>
<div class="paragraph"><p>To extract the range of pages described by a VAD node, use the vaddump
command. The pages belonging to each VAD node are placed in separate files
(named according to the starting and ending addresses). If any pages in the
range are not memory resident, they are zero padded.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 vaddump -D vads
Volatile Systems Volatility Framework 2.1_alpha
Pid:      4
************************************************************************
Pid:    208
************************************************************************
Pid:    296
************************************************************************
Pid:    332
************************************************************************
Pid:    344
************************************************************************
...

$ ls -alh vads
total 229536
drwxr-xr-x  107 Michael  staff   3.6K Jun 24 16:15 .
drwxr-xr-x   25 Michael  staff   850B Jun 24 16:14 ..
-rw-r--r--    1 Michael  staff   140K Jun 24 16:15 System.17fef9e0.00010000-00032fff.dmp
-rw-r--r--    1 Michael  staff   4.0K Jun 24 16:15 System.17fef9e0.00040000-00040fff.dmp
-rw-r--r--    1 Michael  staff   1.7M Jun 24 16:15 System.17fef9e0.76d40000-76eeafff.dmp
-rw-r--r--    1 Michael  staff   1.5M Jun 24 16:15 System.17fef9e0.76f20000-7709ffff.dmp
-rw-r--r--    1 Michael  staff    64K Jun 24 16:15 System.17fef9e0.7ffe0000-7ffeffff.dmp
-rw-r--r--    1 Michael  staff   1.0M Jun 24 16:15 csrss.exe.176006c0.00000000-000fffff.dmp
-rw-r--r--    1 Michael  staff   412K Jun 24 16:15 csrss.exe.176006c0.00100000-00166fff.dmp
-rw-r--r--    1 Michael  staff   4.0K Jun 24 16:15 csrss.exe.176006c0.00170000-00170fff.dmp
-rw-r--r--    1 Michael  staff   8.0K Jun 24 16:15 csrss.exe.176006c0.00180000-00181fff.dmp
-rw-r--r--    1 Michael  staff   4.0K Jun 24 16:15 csrss.exe.176006c0.00190000-00190fff.dmp
...</code></pre>
</div></div>
<div class="paragraph"><p>The files are named like this:</p></div>
<div class="paragraph"><p>ProcessName.PhysicalOffset.StartingVPN.EndingVPN.dmp</p></div>
<div class="paragraph"><p>The reason the PhysicalOffset field exists is so you can distinguish between two
processes with the same name.</p></div>
</div>
<div class="sect2">
<h3 id="_evtlogs">3.18. evtlogs</h3>
<div class="paragraph"><p>The evtlogs command extracts and parses binary event logs from memory. Binary
event logs are found on Windows XP and 2003 machines, therefore this plugin only
works on these architectures.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ vol.py --profile 'WinXPSP2x86' --filename 'xp-laptop-2005-06-25.img' evtlogs

TimeWritten Filename Computer Sid Source Event Id Event Type Message
----------- -------- -------- --- ------ -------- ---------- -------
2004-05-05 19:36:55 UTC+0000 SecEvent.Evt MOIT-A-PHXMOD2 S-1-5-18 Security 612 Success '-';'+';'+';'+';'+';'+';'-';'-';'-';'-';'+';'+';'+';'+';'+';'+';'+';'+';'MOIT-A-PHXMOD2$';'BALTIMORE';'(0x0,0x3E7)'
2004-05-05 19:36:56 UTC+0000 SecEvent.Evt MOIT-A-PHXMOD2 S-1-5-18 Security 618 Success 'MOIT-A-PHXMOD2$';'BALTIMORE';'(0x0,0x3E7)';'PolEfDat: &lt;binary data&gt; (none);  '
2004-05-05 19:37:03 UTC+0000 SecEvent.Evt MOIT-A-PHXMOD2 S-1-5-18 Security 537 Failure 'AJ.Morning';'BALTIMORE';'11';'User32  ';'Negotiate';'MOIT-A-PHXMOD2';'0xC000005E';'0x0'
2004-05-05 19:37:03 UTC+0000 SecEvent.Evt MOIT-A-PHXMOD2 S-1-5-21-487349131-2095749132-2248483902-19753 Security 528 Success 'AJ.Morning';'BALTIMORE';'(0x0,0x113AD)';'2';'User32  ';'Negotiate';'MOIT-A-PHXMOD2';'{5c92d34f-85d3-2f5d-d036-759d7c97bfd7}'
2004-05-05 19:37:32 UTC+0000 SecEvent.Evt MOIT-A-PHXMOD2 S-1-5-19 Security 528 Success 'LOCAL SERVICE';'NT AUTHORITY';'(0x0,0x3E5)';'5';'Advapi  ';'Negotiate';'';'{00000000-0000-0000-0000-000000000000}'</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_kernel_memory_and_objects">4. Kernel Memory and Objects</h2>
<div class="sectionbody">
<div class="paragraph"><p>Volatility plugins can example kernel memory and object management system.</p></div>
<div class="sect2">
<h3 id="_modules">4.1. modules</h3>
<div class="paragraph"><p>To view the list of kernel drivers loaded on the system, use the modules
command. This walks the doubly-linked list of LDR_DATA_TABLE_ENTRY structures
pointed to by PsLoadedModuleList. Similar to the <a href="#pslist">[pslist]</a> command, this relies
on finding the KDBG structure. In rare cases, you may need to use <a href="#kdbgscan">[kdbgscan]</a>
to find the most appropriate KDBG structure address and then supply it to this
plugin like --kdbg=ADDRESS.</p></div>
<div class="paragraph"><p>It cannot find hidden/unlinked kernel drivers, however <a href="#modscan">[modscan]</a> serves that
purpose. Also, since this plugin uses list walking techniques, you typically can
assume that the order the modules are displayed in the output is the order they
were loaded on the system. For example, below, ntoskrnl.exe was first to load,
followed by hal.dll, etc.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 modules
Volatile Systems Volatility Framework 2.1_alpha
Offset(V)          Name                 Base                             Size File
------------------ -------------------- ------------------ ------------------ ----
0xfffffa80004a11a0 ntoskrnl.exe         0xfffff8000261a000           0x5dd000 \SystemRoot\system32\ntoskrnl.exe
0xfffffa80004a10b0 hal.dll              0xfffff80002bf7000            0x49000 \SystemRoot\system32\hal.dll
0xfffffa80004a7950 kdcom.dll            0xfffff80000bb4000             0xa000 \SystemRoot\system32\kdcom.dll
0xfffffa80004a7860 mcupdate.dll         0xfffff88000c3a000            0x44000 \SystemRoot\system32\mcupdate_GenuineIntel.dll
0xfffffa80004a7780 PSHED.dll            0xfffff88000c7e000            0x14000 \SystemRoot\system32\PSHED.dll
0xfffffa80004a7690 CLFS.SYS             0xfffff88000c92000            0x5e000 \SystemRoot\system32\CLFS.SYS
0xfffffa80004a8010 CI.dll               0xfffff88000cf0000            0xc0000 \SystemRoot\system32\CI.dll
...</code></pre>
</div></div>
<div class="paragraph"><p>The output shows the offset of the LDR_DATA_TABLE_ENTRY structure, which is a
virtual address by default but can be specified as a physical address with the
-P switch as shown below. In either case, the Base column is the virtual address
of the module&#8217;s base in kernel memory (where you&#8217;d expect to find the PE
header).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 modules -P
Offset(P)          Name                 Base                             Size File
------------------ -------------------- ------------------ ------------------ ----
0x0000000017fe01a0 ntoskrnl.exe         0xfffff8000261a000           0x5dd000 \SystemRoot\system32\ntoskrnl.exe
0x0000000017fe00b0 hal.dll              0xfffff80002bf7000            0x49000 \SystemRoot\system32\hal.dll
0x0000000017fe6950 kdcom.dll            0xfffff80000bb4000             0xa000 \SystemRoot\system32\kdcom.dll
0x0000000017fe6860 mcupdate.dll         0xfffff88000c3a000            0x44000 \SystemRoot\system32\mcupdate_GenuineIntel.dll
0x0000000017fe6780 PSHED.dll            0xfffff88000c7e000            0x14000 \SystemRoot\system32\PSHED.dll
0x0000000017fe6690 CLFS.SYS             0xfffff88000c92000            0x5e000 \SystemRoot\system32\CLFS.SYS
0x0000000017fe7010 CI.dll               0xfffff88000cf0000            0xc0000 \SystemRoot\system32\CI.dll
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_modscan">4.2. modscan</h3>
<div class="paragraph"><p>The modscan command finds LDR_DATA_TABLE_ENTRY structures by scanning physical
memory for pool tags. This can pick up previously unloaded drivers and drivers
that have been hidden/unlinked by rootkits. Unlike <a href="#modlist">[modlist]</a> the order of
results has no relationship with the order in which the drivers loaded. As you
can see below, DumpIt?.sys was found at the lowest physical offset, but it was
probably one of the last drivers to load (since it was used to acquire memory).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 modscan
Offset(P)          Name                 Base                             Size File
------------------ -------------------- ------------------ ------------------ ----
0x00000000173b90b0 DumpIt.sys           0xfffff88003980000            0x11000 \??\C:\Windows\SysWOW64\Drivers\DumpIt.sys
0x000000001745b180 mouhid.sys           0xfffff880037e9000             0xd000 \SystemRoot\system32\DRIVERS\mouhid.sys
0x0000000017473010 lltdio.sys           0xfffff88002585000            0x15000 \SystemRoot\system32\DRIVERS\lltdio.sys
0x000000001747f010 rspndr.sys           0xfffff8800259a000            0x18000 \SystemRoot\system32\DRIVERS\rspndr.sys
0x00000000174cac40 dxg.sys              0xfffff96000440000            0x1e000 \SystemRoot\System32\drivers\dxg.sys
0x0000000017600190 monitor.sys          0xfffff8800360c000             0xe000 \SystemRoot\system32\DRIVERS\monitor.sys
0x0000000017601170 HIDPARSE.SYS         0xfffff880037de000             0x9000 \SystemRoot\system32\DRIVERS\HIDPARSE.SYS
0x0000000017604180 USBD.SYS             0xfffff880037e7000             0x2000 \SystemRoot\system32\DRIVERS\USBD.SYS
0x0000000017611d70 cdrom.sys            0xfffff88001944000            0x2a000 \SystemRoot\system32\DRIVERS\cdrom.sys
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_moddump">4.3. moddump</h3>
<div class="paragraph"><p>To extract a kernel driver to a file, use the moddump command. Supply the output
directory with -D or --dump-dir=DIR. Without any additional parameters, all
drivers identified by <a href="#modlist">[modlist]</a> will be dumped. If you want a specific driver,
supply a regular expression of the driver&#8217;s name with --regex=REGEX or the
module&#8217;s base address with --base=BASE.</p></div>
<div class="paragraph"><p>For more information, see BDG&#8217;s Plugin Post: Moddump.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 moddump -D drivers/
Volatile Systems Volatility Framework 2.1_alpha
Dumping ntoskrnl.exe, Base: fffff8000261a000 output: driver.fffff8000261a000.sys
Dumping hal.dll, Base: fffff80002bf7000 output: driver.fffff80002bf7000.sys
Dumping intelide.sys, Base: fffff88000e5c000 output: driver.fffff88000e5c000.sys
Dumping mouclass.sys, Base: fffff8800349b000 output: driver.fffff8800349b000.sys
Dumping msisadrv.sys, Base: fffff88000f7c000 output: driver.fffff88000f7c000.sys
Dumping ndistapi.sys, Base: fffff880035c3000 output: driver.fffff880035c3000.sys
Dumping pacer.sys, Base: fffff88002c5d000 output: driver.fffff88002c5d000.sys
Dumping WDFLDR.SYS, Base: fffff88000f0d000 output: driver.fffff88000f0d000.sys
Dumping usbhub.sys, Base: fffff880036be000 output: driver.fffff880036be000.sys
Dumping hwpolicy.sys, Base: fffff8800149f000 output: driver.fffff8800149f000.sys
Dumping kbdclass.sys, Base: fffff8800348c000 output: driver.fffff8800348c000.sys
Dumping amdxata.sys, Base: fffff88000c00000 output: driver.fffff88000c00000.sys
Dumping crashdmp.sys, Base: fffff88003781000 output: driver.fffff88003781000.sys
Dumping swenum.sys, Base: fffff88003461000 output: driver.fffff88003461000.sys
Cannot dump TSDDD.dll at fffff96000670000
Cannot dump framebuf.dll at fffff960008a0000
...</code></pre>
</div></div>
<div class="paragraph"><p>Similar to <a href="#dlldump">[dlldump]</a>, if critical parts of the PE header are not memory
resident, then rebuilding/extracting the driver may fail. Additionally, for
drivers that are mapped in different sessions (like win32k.sys), there is
currently no way to specify which session to use when acquiring the driver
sample. This will be an enhancement added in the Volatility 2.2 release.</p></div>
</div>
<div class="sect2">
<h3 id="_driverscan">4.4. driverscan</h3>
<div class="paragraph"><p>To find DRIVER_OBJECTs in physical memory using pool tag scanning, use the
driverscan command. This is another way to locate kernel modules, although not
all kernel modules have an associated DRIVER_OBJECT. The DRIVER_OBJECT is what
contains the 28 IRP (Major Function) tables, thus the <a href="#driverirp">[driverirp]</a> command is
based on the methodology used by driverscan.</p></div>
<div class="paragraph"><p>For more information, see Andreas Schuster&#8217;s Scanning for Drivers.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 driverscan
Volatile Systems Volatility Framework 2.1_alpha
Offset(P)          #Ptr #Hnd Start                            Size Service Key          Name         Driver Name
------------------ ---- ---- ------------------ ------------------ -------------------- ------------ -----------
0x00000000174c6350    3    0 0xfffff880037e9000             0xd000 mouhid               mouhid       \Driver\mouhid
0x0000000017660cb0    3    0 0xfffff8800259a000            0x18000 rspndr               rspndr       \Driver\rspndr
0x0000000017663e70    3    0 0xfffff88002585000            0x15000 lltdio               lltdio       \Driver\lltdio
0x0000000017691d70    3    0 0xfffff88001944000            0x2a000 cdrom                cdrom        \Driver\cdrom
0x0000000017692a50    3    0 0xfffff8800196e000             0x9000 Null                 Null         \Driver\Null
0x0000000017695e70    3    0 0xfffff88001977000             0x7000 Beep                 Beep         \Driver\Beep
0x00000000176965c0    3    0 0xfffff8800197e000             0xe000 VgaSave              VgaSave      \Driver\VgaSave
0x000000001769fb00    4    0 0xfffff880019c1000             0x9000 RDPCDD               RDPCDD       \Driver\RDPCDD
0x00000000176a1720    3    0 0xfffff880019ca000             0x9000 RDPENCDD             RDPENCDD     \Driver\RDPENCDD
0x00000000176a2230    3    0 0xfffff880019d3000             0x9000 RDPREFMP             RDPREFMP     \Driver\RDPREFMP
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_filescan">4.5. filescan</h3>
<div class="paragraph"><p>To find FILE_OBJECTs in physical memory using pool tag scanning, use the
filescan command. This will find open files even if a rootkit is hiding the
files on disk and if the rootkit hooks some API functions to hide the open
handles on a live system. The output shows the physical offset of the
FILE_OBJECT, file name, number of pointers to the object, number of handles to
the object, and the effective permissions granted to the object.</p></div>
<div class="paragraph"><p>For more information, see Andreas Schuster&#8217;s Scanning for File Objects and
Linking File Objects To Processes.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 filescan
Volatile Systems Volatility Framework 2.1_alpha
Offset(P)            #Ptr   #Hnd Access Name
------------------ ------ ------ ------ ----
0x000000000126f3a0     14      0 R--r-d \Windows\System32\mswsock.dll
0x000000000126fdc0     11      0 R--r-d \Windows\System32\ssdpsrv.dll
0x000000000468f7e0      6      0 R--r-d \Windows\System32\cryptsp.dll
0x000000000468fdc0     16      0 R--r-d \Windows\System32\Apphlpdm.dll
0x00000000048223a0      1      1 ------ \Endpoint
0x0000000004822a30     16      0 R--r-d \Windows\System32\kerberos.dll
0x0000000004906070     13      0 R--r-d \Windows\System32\wbem\repdrvfs.dll
0x0000000004906580      9      0 R--r-d \Windows\SysWOW64\netprofm.dll
0x0000000004906bf0      9      0 R--r-d \Windows\System32\wbem\wmiutils.dll
0x00000000049ce8e0      2      1 R--rwd \$Extend\$ObjId
0x00000000049cedd0      1      1 R--r-d \Windows\System32\en-US\vsstrace.dll.mui
0x0000000004a71070     17      1 R--r-d \Windows\System32\en-US\pnidui.dll.mui
0x0000000004a71440     11      0 R--r-d \Windows\System32\nci.dll
0x0000000004a719c0      1      1 ------ \srvsvc
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_mutantscan">4.6. mutantscan</h3>
<div class="paragraph"><p>To scan physical memory for KMUTANT objects with pool tag scanning, use the
mutantscan command. By default, it displays all objects, but you can pass -s or
--silent to only show named mutexes. The CID column contains the process ID and
thread ID of the mutex owner if one exists.</p></div>
<div class="paragraph"><p>For more information, see Andreas Schuster&#8217;s Searching for Mutants.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 mutantscan --silent
Volatile Systems Volatility Framework 2.1_alpha
Offset(P)          #Ptr #Hnd Signal Thread                   CID Name
------------------ ---- ---- ------ ------------------ --------- ----
0x000000000f702630    2    1      1 0x0000000000000000           {A3BD3259-3E4F-428a-84C8-F0463A9D3EB5}
0x00000000102fd930    2    1      1 0x0000000000000000           Feed Arbitration Shared Memory Mutex [ User : S-1-5-21-2628989162-3383567662-1028919141-1000 ]
0x00000000104e5e60    3    2      1 0x0000000000000000           ZoneAttributeCacheCounterMutex
0x0000000010c29e40    2    1      1 0x0000000000000000           _!MSFTHISTORY!_LOW!_
0x0000000013035080    2    1      1 0x0000000000000000           c:!users!testing!appdata!local!microsoft!feeds cache!
0x000000001722dfc0    2    1      1 0x0000000000000000           c:!users!testing!appdata!roaming!microsoft!windows!ietldcache!low!
0x00000000172497f0    2    1      1 0x0000000000000000           LRIEElevationPolicyMutex
0x000000001724bfc0    3    2      1 0x0000000000000000           !BrowserEmulation!SharedMemory!Mutex
0x000000001724f400    2    1      1 0x0000000000000000           c:!users!testing!appdata!local!microsoft!windows!history!low!history.ie5!mshist012012022220120223!
0x000000001724f4c0    4    3      1 0x0000000000000000           _!SHMSFTHISTORY!_
0x00000000172517c0    2    1      1 0x0000000000000000           __DDrawExclMode__
0x00000000172783a0    2    1      1 0x0000000000000000           Lowhttp://sourceforge.net/
0x00000000172db840    4    3      1 0x0000000000000000           ConnHashTable<img src="images/icons/callouts/1892.png" alt="1892" />_HashTable_Mutex
0x00000000172de1d0    2    1      1 0x0000000000000000           Feeds Store Mutex S-1-5-21-2628989162-3383567662-1028919141-1000
0x00000000173b8080    2    1      1 0x0000000000000000           DDrawDriverObjectListMutex
0x00000000173bd340    2    1      0 0xfffffa8000a216d0 1652:2000 ALTTAB_RUNNING_MUTEX
0x0000000017449c40    2    1      1 0x0000000000000000           DDrawWindowListMutex
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_symlinkscan">4.7. symlinkscan</h3>
<div class="paragraph"><p>This plugin scans for symbolic link objects and outputs their information.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 symlinkscan
Volatile Systems Volatility Framework 2.1_alpha
Offset(P)            #Ptr   #Hnd Creation time            From                 To
------------------ ------ ------ ------------------------ -------------------- ------------------------------------------------------------
0x0000000000469780      1      0 2012-02-22 20:03:13      UMB#UMB#1...e1ba19f} \Device\00000048
0x0000000000754560      1      0 2012-02-22 20:03:15      ASYNCMAC             \Device\ASYNCMAC
0x0000000000ef6cf0      2      1 2012-02-22 19:58:24      0                    \BaseNamedObjects
0x00000000014b2a10      1      0 2012-02-22 20:02:10      LanmanRedirector     \Device\Mup\;LanmanRedirector
0x00000000053e56f0      1      0 2012-02-22 20:03:15      SW#{eeab7...abac361} \Device\KSENUM#00000001
0x0000000005cc0770      1      0 2012-02-22 19:58:20      WanArpV6             \Device\WANARPV6
0x0000000005cc0820      1      0 2012-02-22 19:58:20      WanArp               \Device\WANARP
0x0000000008ffa680      1      0 2012-02-22 19:58:24      Global               \BaseNamedObjects
0x0000000009594810      1      0 2012-02-22 19:58:24      KnownDllPath         C:\Windows\syswow64
0x000000000968f5f0      1      0 2012-02-22 19:58:23      KnownDllPath         C:\Windows\system32
0x000000000ab24060      1      0 2012-02-22 19:58:20      Volume{3b...f6e6963} \Device\CdRom0
0x000000000ab24220      1      0 2012-02-22 19:58:21      {EE0434CC...863ACC2} \Device\NDMP2
0x000000000abd3460      1      0 2012-02-22 19:58:21      ACPI#PNP0...91405dd} \Device\00000041
0x000000000abd36f0      1      0 2012-02-22 19:58:21      {802389A0...A90C31A} \Device\NDMP3
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_thrdscan">4.8. thrdscan</h3>
<div class="paragraph"><p>To find ETHREAD objects in physical memory with pool tag scanning, use the
thrdscan command. Since an ETHREAD contains fields that identify its parent
process, you can use this technique to find hidden processes. One such use case
is documented in the <a href="#psxview">[psxview]</a> command. Also, for verbose details, try the
<a href="#threads">[threads]</a> plugin.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 thrdscan
Volatile Systems Volatility Framework 2.1_alpha
Offset(P)             PID    TID      Start Address Create Time               Exit Time
------------------ ------ ------ ------------------ ------------------------- -------------------------
0x0000000008df68d0    280    392         0x77943260 2012-02-22 19:08:18
0x000000000eac3850   2040    144         0x76d73260 2012-02-22 11:28:59       2012-02-22 11:29:04
0x000000000fd82590    880   1944         0x76d73260 2012-02-22 20:02:29       2012-02-22 20:02:29
0x00000000103d15f0    880    884         0x76d73260 2012-02-22 19:58:43
0x00000000103e5480   1652   1788 0xfffff8a0010ed490 2012-02-22 20:03:44
0x00000000105a3940    916    324         0x76d73260 2012-02-22 20:02:07       2012-02-22 20:02:09
0x00000000105b3560    816    824         0x76d73260 2012-02-22 19:58:42
0x00000000106d1710    916   1228         0x76d73260 2012-02-22 20:02:11
0x0000000010a349a0    816    820         0x76d73260 2012-02-22 19:58:41
0x0000000010bd1060   1892   2280         0x76d73260 2012-02-22 11:26:13
0x0000000010f24230    628    660         0x76d73260 2012-02-22 19:58:34
0x0000000010f27060    568    648 0xfffff8a0017c6650 2012-02-22 19:58:34
...</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_networking">5. Networking</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_connections">5.1. connections</h3>
<div class="paragraph"><p>To view TCP connections that were active at the time of the memory acquisition,
use the connections command. This walks the singly-linked list of connection
structures pointed to by a non-exported symbol in the tcpip.sys module.</p></div>
<div class="paragraph"><p>This command is for x86 and x64 Windows XP and Windows 2003 Server only.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f Win2003SP2x64.vmem --profile=Win2003SP2x64 connections
Volatile Systems Volatility Framework 2.1_alpha
Offset(V)          Local Address             Remote Address               Pid
------------------ ------------------------- ------------------------- ------
0xfffffadfe6f2e2f0 172.16.237.150:1408       72.246.25.25:80             2136
0xfffffadfe72e8080 172.16.237.150:1369       64.4.11.30:80               2136
0xfffffadfe622d010 172.16.237.150:1403       74.125.229.188:80           2136
0xfffffadfe62e09e0 172.16.237.150:1352       64.4.11.20:80               2136
0xfffffadfe6f2e630 172.16.237.150:1389       209.191.122.70:80           2136
0xfffffadfe5e7a610 172.16.237.150:1419       74.125.229.187:80           2136
0xfffffadfe7321bc0 172.16.237.150:1418       74.125.229.188:80           2136
0xfffffadfe5ea3c90 172.16.237.150:1393       216.115.98.241:80           2136
0xfffffadfe72a3a80 172.16.237.150:1391       209.191.122.70:80           2136
0xfffffadfe5ed8560 172.16.237.150:1402       74.125.229.188:80           2136</code></pre>
</div></div>
<div class="paragraph"><p>Output includes the virtual offset of the _TCPT_OBJECT by default. The physical
offset can be obtained with the -P switch.</p></div>
</div>
<div class="sect2">
<h3 id="_connscan">5.2. connscan</h3>
<div class="paragraph"><p>To find _TCPT_OBJECT structures using pool tag scanning, use the connscan
command. This can find artifacts from previous connections that have since been
terminated, in addition to the active ones. In the output below, you&#8217;ll notice
some fields have been partially overwritten, but some of the information is
still accurate. For example, the very last entry&#8217;s Pid field is 0, but all other
fields are still in tact. Thus, while it may find false positives sometimes, you
also get the benefit of detecting as much information as possible.</p></div>
<div class="paragraph"><p>This command is for x86 and x64 Windows XP and Windows 2003 Server only.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f Win2K3SP0x64.vmem --profile=Win2003SP2x64 connscan
Volatile Systems Volatility Framework 2.1_alpha
 Offset(P)  Local Address             Remote Address            Pid
---------- ------------------------- ------------------------- ------
0x0ea7a610 172.16.237.150:1419       74.125.229.187:80           2136
0x0eaa3c90 172.16.237.150:1393       216.115.98.241:80           2136
0x0eaa4480 172.16.237.150:1398       216.115.98.241:80           2136
0x0ead8560 172.16.237.150:1402       74.125.229.188:80           2136
0x0ee2d010 172.16.237.150:1403       74.125.229.188:80           2136
0x0eee09e0 172.16.237.150:1352       64.4.11.20:80               2136
0x0f9f83c0 172.16.237.150:1425       98.139.240.23:80            2136
0x0f9fe010 172.16.237.150:1394       216.115.98.241:80           2136
0x0fb2e2f0 172.16.237.150:1408       72.246.25.25:80             2136
0x0fb2e630 172.16.237.150:1389       209.191.122.70:80           2136
0x0fb72730 172.16.237.150:1424       98.139.240.23:80            2136
0x0fea3a80 172.16.237.150:1391       209.191.122.70:80           2136
0x0fee8080 172.16.237.150:1369       64.4.11.30:80               2136
0x0ff21bc0 172.16.237.150:1418       74.125.229.188:80           2136
0x1019ec90 172.16.237.150:1397       216.115.98.241:80           2136
0x179099e0 172.16.237.150:1115       66.150.117.33:80            2856
0x2cdb1bf0 172.16.237.150:139        172.16.237.1:63369             4
0x339c2c00 172.16.237.150:1138       23.45.66.43:80              1332
0x39b10010 172.16.237.150:1148       172.16.237.138:139             0</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_sockets">5.3. sockets</h3>
<div class="paragraph"><p>To detect listening sockets for any protocol (TCP, UDP, RAW, etc), use the
sockets command. This walks a singly-linked list of socket structures which is
pointed to by a non-exported symbol in the tcpip.sys module.</p></div>
<div class="paragraph"><p>This command is for x86 and x64 Windows XP and Windows 2003 Server only.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f Win2K3SP0x64.vmem --profile=Win2003SP2x64 sockets
Volatile Systems Volatility Framework 2.1_alpha
Offset(V)             PID   Port  Proto Protocol        Address         Create Time
------------------ ------ ------ ------ --------------- --------------- -----------
0xfffffadfe71bbda0    432   1025      6 TCP             0.0.0.0         2012-01-23 18:20:01
0xfffffadfe7350490    776   1028     17 UDP             0.0.0.0         2012-01-23 18:21:44
0xfffffadfe6281120    804    123     17 UDP             127.0.0.1       2012-06-25 12:40:55
0xfffffadfe7549010    432    500     17 UDP             0.0.0.0         2012-01-23 18:20:09
0xfffffadfe5ee8400      4      0     47 GRE             0.0.0.0         2012-02-24 18:09:07
0xfffffadfe606dc90      4    445      6 TCP             0.0.0.0         2012-01-23 18:19:38
0xfffffadfe6eef770      4    445     17 UDP             0.0.0.0         2012-01-23 18:19:38
0xfffffadfe7055210   2136   1321     17 UDP             127.0.0.1       2012-05-09 02:09:59
0xfffffadfe750c010      4    139      6 TCP             172.16.237.150  2012-06-25 12:40:55
0xfffffadfe745f610      4    138     17 UDP             172.16.237.150  2012-06-25 12:40:55
0xfffffadfe6096560      4    137     17 UDP             172.16.237.150  2012-06-25 12:40:55
0xfffffadfe7236da0    720    135      6 TCP             0.0.0.0         2012-01-23 18:19:51
0xfffffadfe755c5b0   2136   1419      6 TCP             0.0.0.0         2012-06-25 12:42:37
0xfffffadfe6f36510   2136   1418      6 TCP             0.0.0.0         2012-06-25 12:42:37
...</code></pre>
</div></div>
<div class="paragraph"><p>Output includes the virtual offset of the _ADDRESS_OBJECT by default. The
physical offset can be obtained with the -P switch.</p></div>
</div>
<div class="sect2">
<h3 id="_sockscan">5.4. sockscan</h3>
<div class="paragraph"><p>To find _ADDRESS_OBJECT structures using pool tag scanning, use the sockscan
command. As with connscan, this can pick up residual data and artifacts from
previous sockets.</p></div>
<div class="paragraph"><p>This command is for x86 and x64 Windows XP and Windows 2003 Server only.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f Win2K3SP0x64.vmem --profile=Win2003SP2x64 sockscan
Volatile Systems Volatility Framework 2.1_alpha
Offset(P)             PID   Port  Proto Protocol        Address         Create Time
------------------ ------ ------ ------ --------------- --------------- -----------
0x0000000000608010    804    123     17 UDP             172.16.237.150  2012-05-08 22:17:44
0x000000000eae8400      4      0     47 GRE             0.0.0.0         2012-02-24 18:09:07
0x000000000eaf1240   2136   1403      6 TCP             0.0.0.0         2012-06-25 12:42:37
0x000000000ec6dc90      4    445      6 TCP             0.0.0.0         2012-01-23 18:19:38
0x000000000ec96560      4    137     17 UDP             172.16.237.150  2012-06-25 12:40:55
0x000000000ecf7d20   2136   1408      6 TCP             0.0.0.0         2012-06-25 12:42:37
0x000000000ed5a010   2136   1352      6 TCP             0.0.0.0         2012-06-25 12:42:18
0x000000000ed84ca0    804    123     17 UDP             172.16.237.150  2012-06-25 12:40:55
0x000000000ee2d380   2136   1393      6 TCP             0.0.0.0         2012-06-25 12:42:37
0x000000000ee81120    804    123     17 UDP             127.0.0.1       2012-06-25 12:40:55
0x000000000eeda8c0    776   1363     17 UDP             0.0.0.0         2012-06-25 12:42:20
0x000000000f0be1a0   2136   1402      6 TCP             0.0.0.0         2012-06-25 12:42:37
0x000000000f0d0890      4   1133      6 TCP             0.0.0.0         2012-02-24 18:09:07
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_netscan">5.5. netscan</h3>
<div class="paragraph"><p>To scan for network artifacts in 32- and 64-bit Windows Vista, Windows 2008
Server and Windows 7 memory dumps, use the netscan command. This finds TCP
endpoints, TCP listeners, UDP endpoints, and UDP listeners. It distinguishes
between IPv4 and IPv6, prints the local and remote IP (if applicable), the local
and remote port (if applicable), the time when the socket was bound or when the
connection was established, and the current state (for TCP connections
only). For more information, see Volatility&#8217;s New Netscan Module.</p></div>
<div class="paragraph"><p>Please note the following:</p></div>
<div class="paragraph"><p>The netscan command uses pool tag scanning There are at least 2 alternate ways
to enumerate connections and sockets on Vista+ operating systems. One of them is
using partitions and dynamic hash tables, which is how the netstat.exe utility
on Windows systems works. The other involves bitmaps and port pools. Plugins for
both of these methods exist for the Volatility 2.1 framework, but are currently
not in the public trunk.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 netscan
Volatile Systems Volatility Framework 2.1_alpha
Offset(P)  Proto    Local Address                  Foreign Address      State            Pid      Owner          Created
0xf882a30  TCPv4    0.0.0.0:135                    0.0.0.0:0            LISTENING        628      svchost.exe
0xfc13770  TCPv4    0.0.0.0:49154                  0.0.0.0:0            LISTENING        916      svchost.exe
0xfdda1e0  TCPv4    0.0.0.0:49154                  0.0.0.0:0            LISTENING        916      svchost.exe
0xfdda1e0  TCPv6    :::49154                       :::0                 LISTENING        916      svchost.exe
0x1121b7b0 TCPv4    0.0.0.0:135                    0.0.0.0:0            LISTENING        628      svchost.exe
0x1121b7b0 TCPv6    :::135                         :::0                 LISTENING        628      svchost.exe
0x11431360 TCPv4    0.0.0.0:49152                  0.0.0.0:0            LISTENING        332      wininit.exe
0x11431360 TCPv6    :::49152                       :::0                 LISTENING        332      wininit.exe

...

0x17de8980 TCPv6    :::49153                       :::0                 LISTENING        444      lsass.exe
0x17f35240 TCPv4    0.0.0.0:49155                  0.0.0.0:0            LISTENING        880      svchost.exe
0x17f362b0 TCPv4    0.0.0.0:49155                  0.0.0.0:0            LISTENING        880      svchost.exe
0x17f362b0 TCPv6    :::49155                       :::0                 LISTENING        880      svchost.exe
0xfd96570  TCPv4    -:0                            232.9.125.0:0        CLOSED           1        ?C?
0x17236010 TCPv4    -:49227                        184.26.31.55:80      CLOSED           2820     iexplore.exe
0x1725d010 TCPv4    -:49359                        93.184.220.20:80     CLOSED           2820     iexplore.exe
0x17270530 TCPv4    10.0.2.15:49363                173.194.35.38:80     ESTABLISHED      2820     iexplore.exe
0x17285010 TCPv4    -:49341                        82.165.218.111:80    CLOSED           2820     iexplore.exe
0x17288a90 TCPv4    10.0.2.15:49254                74.125.31.157:80     CLOSE_WAIT       2820     iexplore.exe
0x1728f6b0 TCPv4    10.0.2.15:49171                204.245.34.130:80    ESTABLISHED      2820     iexplore.exe
0x17291ba0 TCPv4    10.0.2.15:49347                173.194.35.36:80     CLOSE_WAIT       2820     iexplore.exe

...

0x17854010 TCPv4    -:49168                        157.55.15.32:80      CLOSED           2820     iexplore.exe
0x178a2a20 TCPv4    -:0                            88.183.123.0:0       CLOSED           504      svchost.exe
0x178f5b00 TCPv4    10.0.2.15:49362                173.194.35.38:80     CLOSE_WAIT       2820     iexplore.exe
0x17922910 TCPv4    -:49262                        184.26.31.55:80      CLOSED           2820     iexplore.exe
0x17a9d860 TCPv4    10.0.2.15:49221                204.245.34.130:80    ESTABLISHED      2820     iexplore.exe
0x17ac84d0 TCPv4    10.0.2.15:49241                74.125.31.157:80     CLOSE_WAIT       2820     iexplore.exe
0x17b9acf0 TCPv4    10.0.2.15:49319                74.125.127.148:80    CLOSE_WAIT       2820     iexplore.exe
0x10f38d70 UDPv4    10.0.2.15:1900                 *:*                                   1736     svchost.exe    2012-02-22 20:04:12
0x173b3dc0 UDPv4    0.0.0.0:59362                  *:*                                   1736     svchost.exe    2012-02-22 20:02:27
0x173b3dc0 UDPv6    :::59362                       *:*                                   1736     svchost.exe    2012-02-22 20:02:27
0x173b4cf0 UDPv4    0.0.0.0:3702                   *:*                                   1736     svchost.exe    2012-02-22 20:02:27
0x173b4cf0 UDPv6    :::3702                        *:*                                   1736     svchost.exe    2012-02-22 20:02:27
...</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_registry">6. Registry</h2>
<div class="sectionbody">
<div class="paragraph"><p>Volatility has the ability to carve registry data. For more information, see
BDG&#8217;s Memory Registry Tools and Registry Code Updates.</p></div>
<div class="sect2">
<h3 id="_hivescan">6.1. hivescan</h3>
<div class="paragraph"><p>To find the physical addresses of CMHIVEs (registry hives) in memory, use the
hivescan command. For more information, see BDG&#8217;s Enumerating Registry Hives.</p></div>
<div class="paragraph"><p>This plugin isn&#8217;t generally useful by itself. It is used by other plugins (such
as <a href="#hivelist">[hivelist]</a> below) that build on and interpret the information found in
CMHIVEs.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   $python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 hivescan
   Volatile Systems Volatility Framework 2.1_alpha
   Offset(P)
   ------------------
   0x0000000008c95010
   0x000000000aa1a010
   0x000000000acf9010
   0x000000000b1a9010
   0x000000000c2b4010
   0x000000000cd20010
   0x000000000da51010
   ...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_hivelist">6.2. hivelist</h3>
<div class="paragraph"><p>To locate the virtual addresses of registry hives in memory, and the full paths
to the corresponding hive on disk, use the hivelist command. If you want to
print values from a certain hive, run this command first so you can see the
address of the hives.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 hivelist
Volatile Systems Volatility Framework 2.1_alpha
Virtual            Physical           Name
------------------ ------------------ ----
0xfffff8a001053010 0x000000000b1a9010 \??\C:\System Volume Information\Syscache.hve
0xfffff8a0016a7420 0x0000000012329420 \REGISTRY\MACHINE\SAM
0xfffff8a0017462a0 0x00000000101822a0 \??\C:\Windows\ServiceProfiles\NetworkService\NTUSER.DAT
0xfffff8a001abe420 0x000000000eae0420 \??\C:\Windows\ServiceProfiles\LocalService\NTUSER.DAT
0xfffff8a002ccf010 0x0000000014659010 \??\C:\Users\testing\AppData\Local\Microsoft\Windows\UsrClass.dat
0xfffff80002b53b10 0x000000000a441b10 [no name]
0xfffff8a00000d010 0x000000000ddc6010 [no name]
0xfffff8a000022010 0x000000000da51010 \REGISTRY\MACHINE\SYSTEM
0xfffff8a00005c010 0x000000000dacd010 \REGISTRY\MACHINE\HARDWARE
0xfffff8a00021d010 0x000000000cd20010 \SystemRoot\System32\Config\SECURITY
0xfffff8a0009f1010 0x000000000aa1a010 \Device\HarddiskVolume1\Boot\BCD
0xfffff8a000a15010 0x000000000acf9010 \SystemRoot\System32\Config\SOFTWARE
0xfffff8a000ce5010 0x0000000008c95010 \SystemRoot\System32\Config\DEFAULT
0xfffff8a000f95010 0x000000000c2b4010 \??\C:\Users\testing\ntuser.dat</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_printkey">6.3. printkey</h3>
<div class="paragraph"><p>To display the subkeys, values, data, and data types contained within a
specified registry key, use the printkey command. By default, printkey will
search all hives and print the key information (if found) for the requested
key. Therefore, if the key is located in more than one hive, the information for
the key will be printed for each hive that contains it.</p></div>
<div class="paragraph"><p>Say you want to traverse into the HKEY_LOCAL_MACHINE\Microsoft\Security
Center\Svc key. You can do that in the following manner. Note: if you&#8217;re running
Volatility on Windows, enclose the key in double quotes (see issue 166 ).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   $ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 printkey -K "Microsoft\Security Center\Svc"
   Volatile Systems Volatility Framework 2.1_alpha
   Legend: (S) = Stable   (V) = Volatile

   ----------------------------
   Registry: \SystemRoot\System32\Config\SOFTWARE
   Key name: Svc (S)
   Last updated: 2012-02-22 20:04:44

   Subkeys:
     (V) Vol

   Values:
   REG_QWORD     VistaSp1        : (S) 128920218544262440
   REG_DWORD     AntiSpywareOverride : (S) 0
   REG_DWORD     ConfigMask      : (S) 4361</code></pre>
</div></div>
<div class="paragraph"><p>Here you can see how the output appears when multiple hives (DEFAULT and
ntuser.dat) contain the same key "Software\Microsoft\Windows NT\CurrentVersion".</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   $ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 printkey -K "Software\Microsoft\Windows NT\CurrentVersion"
   Volatile Systems Volatility Framework 2.1_alpha
   Legend: (S) = Stable   (V) = Volatile

   ----------------------------
   Registry: \SystemRoot\System32\Config\DEFAULT
   Key name: CurrentVersion (S)
   Last updated: 2009-07-14 04:53:31

   Subkeys:
     (S) Devices
     (S) PrinterPorts

   Values:
   ----------------------------
   Registry: \??\C:\Users\testing\ntuser.dat
   Key name: CurrentVersion (S)
   Last updated: 2012-02-22 11:26:13

   Subkeys:
     (S) Devices
     (S) EFS
     (S) MsiCorruptedFileRecovery
     (S) Network
     (S) PeerNet
     (S) PrinterPorts
     (S) Windows
     (S) Winlogon

   ...</code></pre>
</div></div>
<div class="paragraph"><p>If you want to limit your search to a specific hive, printkey also accepts a
virtual address to the hive. For example, to see the contents of
HKEY_LOCAL_MACHINE, use the command below. Note: the offset is taken from the
previous <a href="#hivelist">[hivelist]</a> output.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   $ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 printkey -o 0xfffff8a000a15010
   Volatile Systems Volatility Framework 2.1_alpha
   Legend: (S) = Stable   (V) = Volatile

   ----------------------------
   Registry: User Specified
   Key name: CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902} (S)
   Last updated: 2009-07-14 07:13:38

   Subkeys:
     (S) ATI Technologies
     (S) Classes
     (S) Clients
     (S) Intel
     (S) Microsoft
     (S) ODBC
     (S) Policies
     (S) RegisteredApplications
     (S) Sonic
     (S) Wow6432Node</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_hivedump">6.4. hivedump</h3>
<div class="paragraph"><p>To recursively list all subkeys in a hive, use the hivedump command and pass it
the virtual address to the desired hive.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 hivedump -o 0xfffff8a000a15010
Volatile Systems Volatility Framework 2.1_alpha
Last Written         Key
2009-07-14 07:13:38  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}
2009-07-14 04:48:57  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}\ATI Technologies
2009-07-14 04:48:57  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}\ATI Technologies\Install
2009-07-14 04:48:57  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}\ATI Technologies\Install\South Bridge
2009-07-14 04:48:57  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}\ATI Technologies\Install\South Bridge\ATI_AHCI_RAID
2009-07-14 07:13:39  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}\Classes
2009-07-14 04:53:38  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}\Classes\*
2009-07-14 04:53:38  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}\Classes\*\OpenWithList
2009-07-14 04:53:38  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}\Classes\*\OpenWithList\Excel.exe
2009-07-14 04:53:38  \CMI-CreateHive{199DAFC2-6F16-4946-BF90-5A3FC3A60902}\Classes\*\OpenWithList\IExplore.exe
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_hashdump">6.5. hashdump</h3>
<div class="paragraph"><p>To extract and decrypt cached domain credentials stored in the registry, use the
hashdump command. For more information, see BDG&#8217;s Cached Domain Credentials and
SANS Forensics 2009 - Memory Forensics and Registry Analysis.</p></div>
<div class="paragraph"><p>To use hashdump, pass the virtual address of the SYSTEM hive as -y and the
virtual address of the SAM hive as -s, like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py hashdump -f image.dd -y 0xe1035b60 -s 0xe165cb60
Administrator:500:08f3a52bdd35f179c81667e9d738c5d9:ed88cccbc08d1c18bcded317112555f4:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
HelpAssistant:1000:ddd4c9c883a8ecb2078f88d729ba2e67:e78d693bc40f92a534197dc1d3a6d34f:::
SUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:8bfd47482583168a0ae5ab020e1186a9:::
phoenix:1003:07b8418e83fad948aad3b435b51404ee:53905140b80b6d8cbe1ab5953f7c1c51:::
ASPNET:1004:2b5f618079400df84f9346ce3e830467:aef73a8bb65a0f01d9470fadc55a411c:::
S----:1006:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</code></pre>
</div></div>
<div class="paragraph"><p>Hashes can now be cracked using John the Ripper, rainbow tables, etc.</p></div>
</div>
<div class="sect2">
<h3 id="_lsadump">6.6. lsadump</h3>
<div class="paragraph"><p>To dump LSA secrets from the registry, use the lsadump command. This exposes
information such as the default password (for systems with autologin enabled),
the RDP public key, and credentials used by DPAPI.</p></div>
<div class="paragraph"><p>For more information, see BDG&#8217;s Decrypting LSA Secrets.</p></div>
<div class="paragraph"><p>To use lsadump, pass the virtual address of the SYSTEM hive as the -y parameter and the virtual address of the SECURITY hive as the -s parameter.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f laqma.vmem lsadump -y 0xe1035b60 -s 0xe16a6b60
Volatile Systems Volatility Framework 2.0
L$RTMTIMEBOMB_1320153D-8DA3-4e8e-B27B-0D888223A588

0000   00 92 8D 60 01 FF C8 01                            ...`....

_SC_Dnscache

L$HYDRAENCKEY_28ada6da-d622-11d1-9cb9-00c04fb16e75

0000   52 53 41 32 48 00 00 00 00 02 00 00 3F 00 00 00    RSA2H.......?...
0010   01 00 01 00 37 CE 0C C0 EF EC 13 C8 A4 C5 BC B8    ....7...........
0020   AA F5 1A 7C 50 95 A4 E9 3B BA 41 C8 53 D7 CE C6    ...|P...;.A.S...
0030   CB A0 6A 46 7C 70 F3 21 17 1C FB 79 5C C1 83 68    ..jF|p.!...y...h
0040   91 E5 62 5E 2C AC 21 1E 79 07 A9 21 BB F0 74 E8    ..b^,.!.y..!..t.
0050   85 66 F4 C4 00 00 00 00 00 00 00 00 F9 D7 AD 5C    .f..............
0060   B4 7C FB F6 88 89 9D 2E 91 F2 60 07 10 42 CA 5A    .|........`..B.Z
0070   FC F0 D1 00 0F 86 29 B5 2E 1E 8C E0 00 00 00 00    ......).........
0080   AF 43 30 5F 0D 0E 55 04 57 F9 0D 70 4A C8 36 01    .C0_..U.W..pJ.6.
0090   C2 63 45 59 27 62 B5 77 59 84 B7 65 8E DB 8A E0    .cEY'b.wY..e....
00A0   00 00 00 00 89 19 5E D8 CB 0E 03 39 E2 52 04 37    ......^....9.R.7
00B0   20 DC 03 C8 47 B5 2A B3 9C 01 65 15 FF 0F FF 8F     ...G.*...e.....
00C0   17 9F C1 47 00 00 00 00 1B AC BF 62 4E 81 D6 2A    ...G.......bN..*
00D0   32 98 36 3A 11 88 2D 99 3A EA 59 DE 4D 45 2B 9E    2.6:..-.:.Y.ME+.
00E0   74 15 14 E1 F2 B5 B2 80 00 00 00 00 75 BD A0 36    t...........u..6
00F0   20 AD 29 0E 88 E0 FD 5B AD 67 CA 88 FC 85 B9 82     .)....[.g......
0100   94 15 33 1A F1 65 45 D1 CA F9 D8 4C 00 00 00 00    ..3..eE....L....
0110   71 F0 0B 11 F2 F1 AA C5 0C 22 44 06 E1 38 6C ED    q........"D..8l.
0120   6E 38 51 18 E8 44 5F AD C2 CE 0A 0A 1E 8C 68 4F    n8Q..D_.......hO
0130   4D 91 69 07 DE AA 1A EC E6 36 2A 9C 9C B6 49 1F    M.i......6*...I.
0140   B3 DD 89 18 52 7C F8 96 4F AF 05 29 DF 17 D8 48    ....R|..O..)...H
0150   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0160   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
0170   00 00 00 00 00 00 00 00 00 00 00 00                ............

DPAPI_SYSTEM

0000   01 00 00 00 24 04 D6 B0 DA D1 3C 40 BB EE EC 89    ....$.....&lt;@....
0010   B4 BB 90 5B 9A BF 60 7D 3E 96 72 CD 9A F6 F8 BE    ...[..`}&gt;.r.....
0020   D3 91 5C FA A5 8B E6 B4 81 0D B6 D4                ............</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_userassist">6.7. userassist</h3>
<div class="paragraph"><p>To get the UserAssist? keys from a sample you can use the userassist plugin. For
more information see Gleeda&#8217;s Volatility UserAssist plugin post.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   $ ./vol.py -f win7.vmem --profile=Win7SP0x86 userassist
   Volatile Systems Volatility Framework 2.0
   ----------------------------
   Registry: \??\C:\Users\admin\ntuser.dat
   Key name: Count
   Last updated: 2010-07-06 22:40:25

   Subkeys:

   Values:
   REG_BINARY    Microsoft.Windows.GettingStarted :
   Count:          14
   Focus Count:    21
   Time Focused:   0:07:00.500000
   Last updated:   2010-03-09 19:49:20

   0000   00 00 00 00 0E 00 00 00 15 00 00 00 A0 68 06 00    .............h..
   0010   00 00 80 BF 00 00 80 BF 00 00 80 BF 00 00 80 BF    ................
   0020   00 00 80 BF 00 00 80 BF 00 00 80 BF 00 00 80 BF    ................
   0030   00 00 80 BF 00 00 80 BF FF FF FF FF EC FE 7B 9C    ..............{.
   0040   C1 BF CA 01 00 00 00 00                            ........

   REG_BINARY    UEME_CTLSESSION :
   Count:          187
   Focus Count:    1205
   Time Focused:   6:25:06.216000
   Last updated:   1970-01-01 00:00:00

   ...

   REG_BINARY    %windir%\system32\calc.exe :
   Count:          12
   Focus Count:    17
   Time Focused:   0:05:40.500000
   Last updated:   2010-03-09 19:49:20

   0000   00 00 00 00 0C 00 00 00 11 00 00 00 20 30 05 00    ............ 0..
   0010   00 00 80 BF 00 00 80 BF 00 00 80 BF 00 00 80 BF    ................
   0020   00 00 80 BF 00 00 80 BF 00 00 80 BF 00 00 80 BF    ................
   0030   00 00 80 BF 00 00 80 BF FF FF FF FF EC FE 7B 9C    ..............{.
   0040   C1 BF CA 01 00 00 00 00                            ........
                             ........

   REG_BINARY    Z:\vmware-share\apps\odbg110\OLLYDBG.EXE :
   Count:          11
   Focus Count:    266
   Time Focused:   1:19:58.045000
   Last updated:   2010-03-18 01:56:31

   0000   00 00 00 00 0B 00 00 00 0A 01 00 00 69 34 49 00    ............i4I.
   0010   00 00 80 BF 00 00 80 BF 00 00 80 BF 00 00 80 BF    ................
   0020   00 00 80 BF 00 00 80 BF 00 00 80 BF 00 00 80 BF    ................
   0030   00 00 80 BF 00 00 80 BF FF FF FF FF 70 3B CB 3A    ............p;.:
   0040   3E C6 CA 01 00 00 00 00                            &gt;.......
   ...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_shimcache">6.8. shimcache</h3>
<div class="paragraph"><p>This plugin parses the Application Compatibility Shim Cache registry key.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 shimcache
Volatile Systems Volatility Framework 2.1_alpha
Last Modified: 2009-07-14 01:39:15 , Path: \??\C:\Windows\system32\LogonUI.exe
Last Modified: 2009-07-14 01:39:46 , Path: \??\C:\Windows\System32\svchost.exe
Last Modified: 2009-07-14 01:39:50 , Path: \??\C:\Windows\system32\vssvc.exe
Last Modified: 2009-06-10 20:39:58 , Path: \??\C:\Windows\Microsoft.NET\Framework64\v2.0.50727\mscorsvw.exe
Last Modified: 2009-06-10 21:23:09 , Path: \??\C:\Windows\Microsoft.NET\Framework\v2.0.50727\mscorsvw.exe
Last Modified: 2009-06-10 20:39:44 , Path: \??\C:\Windows\WinSxS\amd64_netfx-clrgc_b03f5f7f11d50a3a_6.1.7600.16385_none_ada52b8ba0da82ba\clrgc.exe
Last Modified: 2009-07-14 01:39:25 , Path: \??\C:\Windows\System32\netsh.exe
Last Modified: 2009-07-14 01:39:07 , Path: \??\C:\Windows\system32\DrvInst.exe</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_getservicesids">6.9. getservicesids</h3>
<div class="paragraph"><p>The getservicesids command calculates the SIDs for services on a machine and
outputs them in Python dictionary format for future use. The service names are
taken from the registry ("SYSTEM\CurrentControlSet\Services"). For more
information on how these SIDs are calculated, see Timeliner Release
Documentation (pdf). Example output can be seen below:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ ./vol.py -f WinXPSP1x64.vmem --profile=WinXPSP2x64 getservicesids
Volatile Systems Volatility Framework 2.2_alpha
servicesids = {
    'S-1-5-80-2675092186-3691566608-1139246469-1504068187-1286574349':
'Abiosdsk',
    'S-1-5-80-850610371-2162948594-2204246734-1395993891-583065928': 'ACPIEC',
    'S-1-5-80-2838020983-819055183-730598559-323496739-448665943': 'adpu160m',
    'S-1-5-80-3218321610-3296847771-3570773115-868698368-3117473630': 'aec',
    'S-1-5-80-1344778701-2960353790-662938617-678076498-4183748354': 'aic78u2',
    'S-1-5-80-1076555770-1261388817-3553637611-899283093-3303637635': 'Alerter',
    'S-1-5-80-1587539839-2488332913-1287008632-3751426284-4220573165': 'AliIde',
    'S-1-5-80-4100430975-1934021090-490597466-3817433801-2954987127': 'AmdIde',
    'S-1-5-80-258649362-1997344556-1754272750-1450123204-3407402222': 'Atdisk',

...</code></pre>
</div></div>
<div class="paragraph"><p>In order to save output to a file, use the --output-file option.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_image_file_types_crash_dumps_hibernation_and_conversion">7. Image file types: Crash Dumps, Hibernation, and Conversion</h2>
<div class="sectionbody">
<div class="paragraph"><p>Volatility supports many image formats, such as Microsoft crash dumps, macho,
elf core dumps and hibernation files in addition to raw memory dumps. All
commands that work on raw dumps also work on crash and hiber images.</p></div>
<div class="sect2">
<h3 id="_crashinfo">7.1. crashinfo</h3>
<div class="paragraph"><p>Information from the crashdump header can be printed using the crashinfo
command. You will see information like that of the Microsoft dumpcheck utility.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f win7_x64.dmp --profile=Win7SP0x64 crashinfo
Volatile Systems Volatility Framework 2.1_alpha
_DMP_HEADER64:
 Majorversion:         0x0000000f (15)
 Minorversion:         0x00001db0 (7600)
 KdSecondaryVersion    0x00000000
 DirectoryTableBase    0x32a44000
 PfnDataBase           0xfffff80002aa8220
 PsLoadedModuleList    0xfffff80002a3de50
 PsActiveProcessHead   0xfffff80002a1fb30
 MachineImageType      0x00008664
 NumberProcessors      0x00000002
 BugCheckCode          0x00000000
 KdDebuggerDataBlock   0xfffff800029e9070
 ProductType           0x00000001
 SuiteMask             0x00000110
 WriterStatus          0x00000000
 Comment               PAGEPAGEPAGEPAGEPAGEPAGE...

Physical Memory Description:
Number of runs: 3
FileOffset    Start Address    Length
00002000      00001000         0009e000
000a0000      00100000         3fde0000
3fe80000      3ff00000         00100000
3ff7f000      3ffff000</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_hibinfo">7.2. hibinfo</h3>
<div class="paragraph"><p>The hibinfo command reveals additional information stored in the hibernation
file, including the state of the Control Registers, such as CR0, etc. It also
identifies the time at which the hibernation file was created, the state of the
hibernation file, and the version of windows being hibernated. Example output
for the function is shown below:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f hiberfil.sys --profile=Win7SP1x64 hibinfo
IMAGE_HIBER_HEADER:
Signature: HIBR
SystemTime: 2011-12-23 16:34:27

Control registers flags
CR0: 80050031
CR0[PAGING]: 1
CR3: 00187000
CR4: 000006f8
CR4[PSE]: 1
CR4[PAE]: 1

Windows Version is 6.1 (7601)</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_imagecopy">7.3. imagecopy</h3>
<div class="paragraph"><p>The imagecopy command allows one to convert any existing type of address space
(such as a crashdump, hibernation file, or live firewire session) to a raw
memory image. This conversion be necessary if some of your other forensic tools
only support reading raw memory dumps.</p></div>
<div class="paragraph"><p>The profile should be specified for this command, so if you don&#8217;t know it
already, use the <a href="#imageinfo">[imageinfo]</a> or <a href="#kdbgscan">[kdbgscan]</a> commands first. The output file
is specified with the -O flag. The progress is updated as the file is converted:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f win7_x64.dmp --profile=Win7SP0x64 imagecopy -O copy.raw
Volatile Systems Volatility Framework 2.1_alpha
Writing data (5.00 MB chunks): |.......................................|</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_raw2dmp">7.4. raw2dmp</h3>
<div class="paragraph"><p>To convert any memory dump (for example from an acquisition or a Virtual Box
image file) into a Microsoft crash dump, use the raw2dmp command. This is useful
if you want to load the memory in the WinDbg kernel debugger for analysis.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 raw2dmp -O copy.dmp
Volatile Systems Volatility Framework 2.1_alpha
Writing data (5.00 MB chunks): |..............................................................................|</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_malware_and_rootkits">8. Malware and Rootkits</h2>
<div class="sectionbody">
<div class="paragraph"><p>Although all Volatility commands can help you hunt malware in one way or
another, there are a few designed specifically for hunting rootkits and
malicious code. The most comprehensive documentation for these commands can be
found in the Malware Analyst&#8217;s Cookbook and DVD: Tools and Techniques For
Fighting Malicious Code.</p></div>
<div class="sect2">
<h3 id="_malfind">8.1. malfind</h3>
<div class="paragraph"><p>The malfind command helps find hidden or injected code/DLLs in user mode memory,
based on characteristics such as VAD tag and page permissions.</p></div>
<div class="paragraph"><p>Note: malfind does not detect DLLs injected into a process using
CreateRemoteThread&#8594;LoadLibrary. DLLs injected with this technique are not
hidden and thus you can view them with <a href="#dlllist">[dlllist]</a>. The purpose of malfind is to
locate DLLs that standard methods/tools do not see. For more information see
Issue #178 .</p></div>
<div class="paragraph"><p>Here is an example of using it to detect the presence of Zeus. The first memory
segment (starting at 0x01600000) was detected because its executable, marked as
private (not shared between processes) and has a VadS tag&#8230;which means there is
no memory mapped file already occupying the space. Based on a disassembly of the
data found at this address, it seems to contain some API hook trampoline stubs.</p></div>
<div class="paragraph"><p>The second memory segment (starting at 0x015D0000) was detected because it
contained an executable that isn&#8217;t listed in the PEB&#8217;s module lists.</p></div>
<div class="paragraph"><p>If you want to save extracted copies of the memory segments identified by
malfind, just supply an output directory with -D or --dump-dir=DIR. In this
case, an unpacked copy of the Zeus binary that was injected into explorer.exe
would be written to disk.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f zeus.vmem malfind -p 1724
Volatile Systems Volatility Framework 2.1_alpha

Process: explorer.exe Pid: 1724 Address: 0x1600000
Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE
Flags: CommitCharge: 1, MemCommit: 1, PrivateMemory: 1, Protection: 6

0x01600000  b8 35 00 00 00 e9 cd d7 30 7b b8 91 00 00 00 e9   .5......0{......
0x01600010  4f df 30 7b 8b ff 55 8b ec e9 ef 17 c1 75 8b ff   O.0{..U......u..
0x01600020  55 8b ec e9 95 76 bc 75 8b ff 55 8b ec e9 be 53   U....v.u..U....S
0x01600030  bd 75 8b ff 55 8b ec e9 d6 18 c1 75 8b ff 55 8b   .u..U......u..U.

0x1600000 b835000000       MOV EAX, 0x35
0x1600005 e9cdd7307b       JMP 0x7c90d7d7
0x160000a b891000000       MOV EAX, 0x91
0x160000f e94fdf307b       JMP 0x7c90df63
0x1600014 8bff             MOV EDI, EDI
0x1600016 55               PUSH EBP

Process: explorer.exe Pid: 1724 Address: 0x15d0000
Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE
Flags: CommitCharge: 38, MemCommit: 1, PrivateMemory: 1, Protection: 6

0x015d0000  4d 5a 90 00 03 00 00 00 04 00 00 00 ff ff 00 00   MZ..............
0x015d0010  b8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00   ........@.......
0x015d0020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0x015d0030  00 00 00 00 00 00 00 00 00 00 00 00 d0 00 00 00   ................

0x15d0000 4d               DEC EBP
0x15d0001 5a               POP EDX
0x15d0002 90               NOP
0x15d0003 0003             ADD [EBX], AL
0x15d0005 0000             ADD [EAX], AL
0x15d0007 000400           ADD [EAX+EAX], AL
0x15d000a 0000             ADD [EAX], AL</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_yarascan">8.2. yarascan</h3>
<div class="paragraph"><p>Volatility has several built-in scanning engines to help you find simple
patterns like pool tags in physical or virtual address spaces. However, if you
need to scan for more complex things like regular expressions or compound rules
(i.e. search for "this" and not "that"), you can use the yarascan command. This
plugin can help you locate any sequence of bytes (like assembly instructions
with wild cards), regular expressions, ANSI strings, or Unicode strings in user
mode or kernel memory.</p></div>
<div class="paragraph"><p>You can create a YARA rules file and specify it as --yara-file=RULESFILE. Or, if
you&#8217;re just looking for something simple, and only plan to do the search a few
times, then you can specify the criteria like --yara-rules=RULESTEXT.</p></div>
<div class="paragraph"><p>To search for signatures defined in the file rules.yar, in any process, and
simply display the results on screen:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$ python vol.py -f zeus.vmem yarascan --yara-file=/path/to/rules.yar</code></pre>
</div></div>
<div class="paragraph"><p>To search for a simple string in any process and dump the memory segments containing a match:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$ python vol.py -f zeus.vmem yarascan -D dump_files --yara-rules="simpleStringToFind"</code></pre>
</div></div>
<div class="paragraph"><p>To search for a byte pattern in kernel memory, use the following technique. This
searches through memory in 1MB chunks, in all sessions. The TDL3 malware applies
a hard-patch to SCSI adaptors on disk (sometimes atapi.sys or vmscsi.sys). In
particular, it adds some shell code to the .rsrc section of the file, and then
modifies the AddressOfEntryPoint so that it points at the shell code. This is
TDL3&#8217;s main persistence method. One of the unique instructions in the shell code
is cmp dword ptr [eax], ‘3LDT’ so I made a YARA signature from those opcodes:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f tdl3.vmem yarascan --yara-rules="{8B 00 81 38 54 44 4C 33 75 5A}" -K
Volatile Systems Volatility Framework 2.1_alpha
Rule: r1
Owner: (Unknown Kernel Memory)
0x8138dcc0  8b 00 81 38 54 44 4c 33 75 5a 8b 45 f4 05 fd 29   ...8TDL3uZ.E...)
0x8138dcd0  b7 f0 50 b8 08 03 00 00 8b 80 00 00 df ff ff b0   ..P.............
0x8138dce0  00 01 00 00 b8 08 03 00 00 8b 80 00 00 df ff 8b   ................
0x8138dcf0  40 04 8b 4d ec 03 41 20 ff d0 ff 75 e0 b8 08 03   @..M..A....u....
Rule: r1
Owner: dump_vmscsi.sys
0xf94bb4c3  8b 00 81 38 54 44 4c 33 75 5a 8b 45 f4 05 fd 29   ...8TDL3uZ.E...)
0xf94bb4d3  b7 f0 50 b8 08 03 00 00 8b 80 00 00 df ff ff b0   ..P.............
0xf94bb4e3  00 01 00 00 b8 08 03 00 00 8b 80 00 00 df ff 8b   ................
0xf94bb4f3  40 04 8b 4d ec 03 41 20 ff d0 ff 75 e0 b8 08 03   @..M..A....u....
Rule: r1
Owner: vmscsi.sys
0xf9dba4c3  8b 00 81 38 54 44 4c 33 75 5a 8b 45 f4 05 fd 29   ...8TDL3uZ.E...)
0xf9dba4d3  b7 f0 50 b8 08 03 00 00 8b 80 00 00 df ff ff b0   ..P.............
0xf9dba4e3  00 01 00 00 b8 08 03 00 00 8b 80 00 00 df ff 8b   ................
0xf9dba4f3  40 04 8b 4d ec 03 41 20 ff d0 ff 75 e0 b8 08 03   @..M..A....u....</code></pre>
</div></div>
<div class="paragraph"><p>Search for a given byte pattern in a particular process:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$ python vol.py -f zeus.vmem yarascan --yara-rules="{eb 90 ff e4 88 32 0d}" --pid=624</code></pre>
</div></div>
<div class="paragraph"><p>Search for a regular expression in a particular process:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>$ python vol.py -f zeus.vmem yarascan --yara-rules="/my(regular|expression{0,2})/" --pid=624</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_svcscan">8.3. svcscan</h3>
<div class="paragraph"><p>Volatility is the only memory forensics framework with the ability to list
services without using the Windows API on a live machine. To see which services
are registered on your memory image, use the svcscan command. The output shows
the process ID of each service (if its active and pertains to a usermode
process), the service name, service display name, service type, and current
status. It also shows the binary path for the registered service - which will be
an EXE for usermode services and a driver name for services that run from kernel
mode.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 svcscan
Volatile Systems Volatility Framework 2.1_alpha
Offset: 0xa26e70
Order: 71
Process ID: 1104
Service Name: DPS
Display Name: Diagnostic Policy Service
Service Type: SERVICE_WIN32_SHARE_PROCESS
Service State: SERVICE_RUNNING
Binary Path: C:\Windows\system32\svchost.exe -k LocalServiceNoNetwork

Offset: 0xa25620
Order: 70
Process ID: -
Service Name: dot3svc
Display Name: Wired AutoConfig
Service Type: SERVICE_WIN32_SHARE_PROCESS
Service State: SERVICE_STOPPED
Binary Path: -

Offset: 0xa25440
Order: 68
Process ID: -
Service Name: Disk
Display Name: Disk Driver
Service Type: SERVICE_KERNEL_DRIVER
Service State: SERVICE_RUNNING
Binary Path: \Driver\Disk

...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_ldrmodules">8.4. ldrmodules</h3>
<div class="paragraph"><p>There are many ways to hide a DLL. One of the ways involves unlinking the DLL
from one (or all) of the linked lists in the PEB. However, when this is done,
there is still information contained within the VAD (Virtual Address Descriptor)
which identifies the base address of the DLL and its full path on disk. To
cross-reference this information (known as memory mapped files) with the 3 PEB
lists, use the ldrmodules command.</p></div>
<div class="paragraph"><p>For each memory mapped PE file, the ldrmodules command prints True or False if
the PE exists in the PEB lists.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 ldrmodules
Volatile Systems Volatility Framework 2.1_alpha
Pid      Process              Base               InLoad InInit InMem MappedPath
-------- -------------------- ------------------ ------ ------ ----- ----------
     208 smss.exe             0x0000000047a90000 True   False  True  \Windows\System32\smss.exe
     296 csrss.exe            0x0000000049700000 True   False  True  \Windows\System32\csrss.exe
     344 csrss.exe            0x0000000000390000 False  False  False \Windows\Fonts\vgasys.fon
     344 csrss.exe            0x00000000007a0000 False  False  False \Windows\Fonts\vgaoem.fon
     344 csrss.exe            0x00000000020e0000 False  False  False \Windows\Fonts\ega40woa.fon
     344 csrss.exe            0x0000000000a60000 False  False  False \Windows\Fonts\dosapp.fon
     344 csrss.exe            0x0000000000a70000 False  False  False \Windows\Fonts\cga40woa.fon
     344 csrss.exe            0x00000000020d0000 False  False  False \Windows\Fonts\cga80woa.fon
     428 services.exe         0x0000000000020000 False  False  False \Windows\System32\en-US\services.exe.mui
     428 services.exe         0x00000000ff670000 True   False  True  \Windows\System32\services.exe
     444 lsass.exe            0x0000000000180000 False  False  False \Windows\System32\en-US\crypt32.dll.mui
     444 lsass.exe            0x0000000076b20000 True   True   True  \Windows\System32\kernel32.dll
     444 lsass.exe            0x0000000076c40000 True   True   True  \Windows\System32\user32.dll
     444 lsass.exe            0x0000000074a70000 True   True   True  \Windows\System32\msprivs.dll
     444 lsass.exe            0x0000000076d40000 True   True   True  \Windows\System32\ntdll.dll
     568 svchost.exe          0x00000000001e0000 False  False  False \Windows\System32\en-US\umpnpmgr.dll.mui
...</code></pre>
</div></div>
<div class="paragraph"><p>Since the PEB and the DLL lists that it contains all exist in user mode, its
also possible for malware to hide (or obscure) a DLL by simply overwriting the
path. Tools that only look for unlinked entries may miss the fact that malware
could overwrite C:\bad.dll to show C:\windows\system32\kernel32.dll. So you can
also pass -v or --verbose to ldrmodules to see the full path of all entries.</p></div>
<div class="paragraph"><p>For concrete examples, see ZeroAccess Misleads Memory-File Link and QuickPost:
Flame &amp; Volatility.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 ldrmodules -v
Volatile Systems Volatility Framework 2.1_alpha
Pid      Process              Base               InLoad InInit InMem MappedPath
-------- -------------------- ------------------ ------ ------ ----- ----------
     208 smss.exe             0x0000000047a90000 True   False  True  \Windows\System32\smss.exe
  Load Path: \SystemRoot\System32\smss.exe : smss.exe
  Mem Path:  \SystemRoot\System32\smss.exe : smss.exe
     296 csrss.exe            0x0000000049700000 True   False  True  \Windows\System32\csrss.exe
  Load Path: C:\Windows\system32\csrss.exe : csrss.exe
  Mem Path:  C:\Windows\system32\csrss.exe : csrss.exe
     344 csrss.exe            0x0000000000390000 False  False  False \Windows\Fonts\vgasys.fon
     344 csrss.exe            0x00000000007a0000 False  False  False \Windows\Fonts\vgaoem.fon
     344 csrss.exe            0x00000000020e0000 False  False  False \Windows\Fonts\ega40woa.fon
     344 csrss.exe            0x0000000000a60000 False  False  False \Windows\Fonts\dosapp.fon
     344 csrss.exe            0x0000000000a70000 False  False  False \Windows\Fonts\cga40woa.fon
     344 csrss.exe            0x00000000020d0000 False  False  False \Windows\Fonts\cga80woa.fon
     428 services.exe         0x0000000000020000 False  False  False \Windows\System32\en-US\services.exe.mui
     428 services.exe         0x00000000ff670000 True   False  True  \Windows\System32\services.exe
  Load Path: C:\Windows\system32\services.exe : services.exe
  Mem Path:  C:\Windows\system32\services.exe : services.exe
     444 lsass.exe            0x0000000000180000 False  False  False \Windows\System32\en-US\crypt32.dll.mui
     444 lsass.exe            0x0000000076b20000 True   True   True  \Windows\System32\kernel32.dll
  Load Path: C:\Windows\system32\kernel32.dll : kernel32.dll
  Init Path: C:\Windows\system32\kernel32.dll : kernel32.dll
  Mem Path:  C:\Windows\system32\kernel32.dll : kernel32.dll
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_impscan">8.5. impscan</h3>
<div class="paragraph"><p>In order to fully reverse engineer code that you find in memory dumps, its
necessary to see which functions the code imports. In other words, which API
functions it calls. When you dump binaries with <a href="#dlldump">[dlldump]</a>, <a href="#moddump">[moddump]</a>, or
<a href="#procexedump">[procexedump]</a>, the IAT (Import Address Table) may not properly be
reconstructed due to the high likelihood that one or more pages in the PE header
or IAT are not memory resident (paged). Thus, we created impscan. Impscan
identifies calls to APIs without parsing a PE&#8217;s IAT. It even works if malware
completely erases the PE header, and it works on kernel drivers.</p></div>
<div class="paragraph"><p>Previous versions of impscan automatically created a labeled IDB for use with
IDA Pro. This functionality has temporarily been disabled, but will return
sometime in the future when other similar functionality is introduced.</p></div>
<div class="paragraph"><p>Take Coreflood for example. This malware deleted its PE header once it loaded in
the target process (by calling VirtualFree on the injected DLL&#8217;s ImageBase). You
can use <a href="#malfind">[malfind]</a> to detect the presence of Coreflood based on the typical
criteria (page permissions, VAD tags, etc). Notice how the PE&#8217;s base address
doesn&#8217;t contain the usual <em>MZ</em> header:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f coreflood.vmem -p 2044 malfind
Volatile Systems Volatility Framework 2.1_alpha

Process: IEXPLORE.EXE Pid: 2044 Address: 0x7ff80000
Vad Tag: VadS Protection: PAGE_EXECUTE_READWRITE
Flags: CommitCharge: 45, PrivateMemory: 1, Protection: 6

0x7ff80000  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0x7ff80010  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0x7ff80020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................
0x7ff80030  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   ................

0x7ff80000 0000             ADD [EAX], AL
0x7ff80002 0000             ADD [EAX], AL
0x7ff80004 0000             ADD [EAX], AL
0x7ff80006 0000             ADD [EAX], AL</code></pre>
</div></div>
<div class="paragraph"><p>Let&#8217;s assume you want to extract the unpacked copy of Coreflood and see its
imported APIs. Use impscan by specifying the base address provided to you by
malfind. In this case, we fixup the base address by 0x1000 to account for the
missing page at the real ImageBase.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f coreflood.vmem -p 2044 impscan -b 0x7ff81000
Volatile Systems Volatility Framework 2.1_alpha
IAT        Call       Module               Function
---------- ---------- -------------------- --------
0x7ff9e000 0x77dd77b3 ADVAPI32.dll         SetSecurityDescriptorDacl
0x7ff9e004 0x77dfd4c9 ADVAPI32.dll         GetUserNameA
0x7ff9e008 0x77dd6bf0 ADVAPI32.dll         RegCloseKey
0x7ff9e00c 0x77ddeaf4 ADVAPI32.dll         RegCreateKeyExA
0x7ff9e010 0x77dfc123 ADVAPI32.dll         RegDeleteKeyA
0x7ff9e014 0x77ddede5 ADVAPI32.dll         RegDeleteValueA
0x7ff9e018 0x77ddd966 ADVAPI32.dll         RegNotifyChangeKeyValue
0x7ff9e01c 0x77dd761b ADVAPI32.dll         RegOpenKeyExA
0x7ff9e020 0x77dd7883 ADVAPI32.dll         RegQueryValueExA
0x7ff9e024 0x77ddebe7 ADVAPI32.dll         RegSetValueExA
0x7ff9e028 0x77dfc534 ADVAPI32.dll         AdjustTokenPrivileges
0x7ff9e02c 0x77e34c3f ADVAPI32.dll         InitiateSystemShutdownA
0x7ff9e030 0x77dfd11b ADVAPI32.dll         LookupPrivilegeValueA
0x7ff9e034 0x77dd7753 ADVAPI32.dll         OpenProcessToken
0x7ff9e038 0x77dfc8c1 ADVAPI32.dll         RegEnumKeyExA
...</code></pre>
</div></div>
<div class="paragraph"><p>If you don&#8217;t specify a base address with -b or --base, then you&#8217;ll end up
scanning the process&#8217;s main module (i.e. IEXPLORE.EXE since that&#8217;s -p 2044) for
imported functions. You can also specify the base address of a kernel driver to
scan the driver for imported kernel-mode functions.</p></div>
<div class="paragraph"><p>Laqma loads a kernel driver named lanmandrv.sys. If you extract it with
<a href="#moddump">[moddump]</a>, the IAT will be corrupt. So use impscan to rebuild it:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f laqma.vmem impscan -b 0xfca29000
Volatile Systems Volatility Framework 2.1_alpha
IAT        Call       Module               Function
---------- ---------- -------------------- --------
0xfca2a080 0x804ede90 ntoskrnl.exe         IofCompleteRequest
0xfca2a084 0x804f058c ntoskrnl.exe         IoDeleteDevice
0xfca2a088 0x80568140 ntoskrnl.exe         IoDeleteSymbolicLink
0xfca2a08c 0x80567dcc ntoskrnl.exe         IoCreateSymbolicLink
0xfca2a090 0x805a2130 ntoskrnl.exe         MmGetSystemRoutineAddress
0xfca2a094 0x805699e0 ntoskrnl.exe         IoCreateDevice
0xfca2a098 0x80544080 ntoskrnl.exe         ExAllocatePoolWithTag
0xfca2a09c 0x80536dc3 ntoskrnl.exe         wcscmp
0xfca2a0a0 0x804fdbc0 ntoskrnl.exe         ZwOpenKey
0xfca2a0a4 0x80535010 ntoskrnl.exe         _except_handler3
0xfca2a3ac 0x8056df44 ntoskrnl.exe         NtQueryDirectoryFile
0xfca2a3b4 0x8060633e ntoskrnl.exe         NtQuerySystemInformation
0xfca2a3bc 0x805bfb78 ntoskrnl.exe         NtOpenProcess</code></pre>
</div></div>
<div class="paragraph"><p>The next example shows impscan on an x64 driver and using the render_idc output
format. This gives you an IDC file you can import into IDA Pro to apply labels
to the function calls.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 \
  impscan -b 0xfffff88003980000 --output=idc --output-file=imps.idc
Volatile Systems Volatility Framework 2.1_alpha

$ cat imps.idc
#include &lt;idc.idc&gt;
static main(void) {
   MakeDword(0xFFFFF8800398A000);
   MakeName(0xFFFFF8800398A000, "KeSetEvent");
   MakeDword(0xFFFFF8800398A008);
   MakeName(0xFFFFF8800398A008, "PsTerminateSystemThread");
   MakeDword(0xFFFFF8800398A010);
   MakeName(0xFFFFF8800398A010, "KeInitializeEvent");
   MakeDword(0xFFFFF8800398A018);
   MakeName(0xFFFFF8800398A018, "PsCreateSystemThread");
   MakeDword(0xFFFFF8800398A020);
   MakeName(0xFFFFF8800398A020, "KeWaitForSingleObject");
   MakeDword(0xFFFFF8800398A028);
   MakeName(0xFFFFF8800398A028, "ZwClose");
   MakeDword(0xFFFFF8800398A030);
   MakeName(0xFFFFF8800398A030, "RtlInitUnicodeString");
...
   MakeDword(0xFFFFF8800398A220);
   MakeName(0xFFFFF8800398A220, "RtlAnsiCharToUnicodeChar");
   MakeDword(0xFFFFF8800398A228);
   MakeName(0xFFFFF8800398A228, "__C_specific_handler");
Exit(0);}</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_apihooks">8.6. apihooks</h3>
<div class="paragraph"><p>To find API hooks in user mode or kernel mode, use the apihooks plugin. This
finds IAT, EAT, Inline style hooks, and several special types of hooks. For
Inline hooks, it detects CALLs and JMPs to direct and indirect locations, and it
detects PUSH/RET instruction sequences. The special types of hooks that it
detects include syscall hooking in ntdll.dll and calls to unknown code pages in
kernel memory.</p></div>
<div class="paragraph"><p>As of Volatility 2.1, apihooks also detects hooked winsock procedure tables,
includes an easier to read output format, supports multiple hop disassembly, and
can optionally scan quicker through memory by ignoring non-critical processes
and DLLs.</p></div>
<div class="paragraph"><p>Here is an example of detecting IAT hooks installed by Coreflood. The hooking
module is unknown because there is no module (DLL) associated with the memory in
which the rootkit code exists. If you want to extract the code containing the
hooks, you have a few options:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
See if <a href="#malfind">[malfind]</a> can automatically find and extract it.
</p>
</li>
<li>
<p>
Use <a href="#volshell">[volshell]</a> dd/db commands to scan backwards and look for an MZ
   header. Then pass that address to <a href="#dlldump">[dlldump]</a> as the --base value.
</p>
</li>
<li>
<p>
Use <a href="#vaddump">[vaddump]</a> to extract all code segments to individual files (named
   according to start and end address), then find the file that contains the
   0x7ff82 ranges.
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f coreflood.vmem -p 2044 apihooks
Volatile Systems Volatility Framework 2.1_alpha
************************************************************************
Hook mode: Usermode
Hook type: Import Address Table (IAT)
Process: 2044 (IEXPLORE.EXE)
Victim module: iexplore.exe (0x400000 - 0x419000)
Function: kernel32.dll!GetProcAddress at 0x7ff82360
Hook address: 0x7ff82360
Hooking module: &lt;unknown&gt;

Disassembly(0):
0x7ff82360 e8fbf5ffff       CALL 0x7ff81960
0x7ff82365 84c0             TEST AL, AL
0x7ff82367 740b             JZ 0x7ff82374
0x7ff82369 8b150054fa7f     MOV EDX, [0x7ffa5400]
0x7ff8236f 8b4250           MOV EAX, [EDX+0x50]
0x7ff82372 ffe0             JMP EAX
0x7ff82374 8b4c2408         MOV ECX, [ESP+0x8]

************************************************************************
Hook mode: Usermode
Hook type: Import Address Table (IAT)
Process: 2044 (IEXPLORE.EXE)
Victim module: iexplore.exe (0x400000 - 0x419000)
Function: kernel32.dll!LoadLibraryA at 0x7ff82a50
Hook address: 0x7ff82a50
Hooking module: &lt;unknown&gt;

Disassembly(0):
0x7ff82a50 51               PUSH ECX
0x7ff82a51 e80aefffff       CALL 0x7ff81960
0x7ff82a56 84c0             TEST AL, AL
0x7ff82a58 7414             JZ 0x7ff82a6e
0x7ff82a5a 8b442408         MOV EAX, [ESP+0x8]
0x7ff82a5e 8b0d0054fa7f     MOV ECX, [0x7ffa5400]
0x7ff82a64 8b512c           MOV EDX, [ECX+0x2c]
0x7ff82a67 50               PUSH EAX

...</code></pre>
</div></div>
<div class="paragraph"><p>Here is an example of detecting the Inline hooks installed by Silentbanker. Note
the multiple hop disassembly which is new in 2.1. It shows the first hop of the
hook at 0x7c81caa2 jumps to 0xe50000. Then you also see a disassembly of the
code at 0xe50000 which executes the rest of the trampoline.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f silentbanker.vmem -p 1884 apihooks
Volatile Systems Volatility Framework 2.1_alpha
************************************************************************
Hook mode: Usermode
Hook type: Inline/Trampoline
Process: 1884 (IEXPLORE.EXE)
Victim module: kernel32.dll (0x7c800000 - 0x7c8f4000)
Function: kernel32.dll!ExitProcess at 0x7c81caa2
Hook address: 0xe50000
Hooking module: &lt;unknown&gt;

Disassembly(0):
0x7c81caa2 e959356384       JMP 0xe50000
0x7c81caa7 6aff             PUSH -0x1
0x7c81caa9 68b0f3e877       PUSH DWORD 0x77e8f3b0
0x7c81caae ff7508           PUSH DWORD [EBP+0x8]
0x7c81cab1 e846ffffff       CALL 0x7c81c9fc

Disassembly(1):
0xe50000 58               POP EAX
0xe50001 680500e600       PUSH DWORD 0xe60005
0xe50006 6800000000       PUSH DWORD 0x0
0xe5000b 680000807c       PUSH DWORD 0x7c800000
0xe50010 6828180310       PUSH DWORD 0x10031828
0xe50015 50               PUSH EAX

...</code></pre>
</div></div>
<div class="paragraph"><p>Here is an example of detecting the PUSH/RET Inline hooks installed by Laqma:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f laqma.vmem -p 1624 apihooks
Volatile Systems Volatility Framework 2.1_alpha
************************************************************************
Hook mode: Usermode
Hook type: Inline/Trampoline
Process: 1624 (explorer.exe)
Victim module: USER32.dll (0x7e410000 - 0x7e4a0000)
Function: USER32.dll!MessageBoxA at 0x7e45058a
Hook address: 0xac10aa
Hooking module: Dll.dll

Disassembly(0):
0x7e45058a 68aa10ac00       PUSH DWORD 0xac10aa
0x7e45058f c3               RET
0x7e450590 3dbc04477e       CMP EAX, 0x7e4704bc
0x7e450595 00742464         ADD [ESP+0x64], DH
0x7e450599 a118000000       MOV EAX, [0x18]
0x7e45059e 6a00             PUSH 0x0
0x7e4505a0 ff               DB 0xff
0x7e4505a1 70               DB 0x70

Disassembly(1):
0xac10aa 53               PUSH EBX
0xac10ab 56               PUSH ESI
0xac10ac 57               PUSH EDI
0xac10ad 90               NOP
0xac10ae 90               NOP

...</code></pre>
</div></div>
<div class="paragraph"><p>Here is an example of using apihooks to detect the syscall patches in ntdll.dll
(using a Carberp sample):</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f carberp.vmem -p 1004 apihooks
Volatile Systems Volatility Framework 2.1_alpha
************************************************************************
Hook mode: Usermode
Hook type: NT Syscall
Process: 1004 (explorer.exe)
Victim module: ntdll.dll (0x7c900000 - 0x7c9af000)
Function: NtQueryDirectoryFile
Hook address: 0x1da658f
Hooking module: &lt;unknown&gt;

Disassembly(0):
0x7c90d750 b891000000       MOV EAX, 0x91
0x7c90d755 ba84ddda01       MOV EDX, 0x1dadd84
0x7c90d75a ff12             CALL DWORD [EDX]
0x7c90d75c c22c00           RET 0x2c
0x7c90d75f 90               NOP
0x7c90d760 b892000000       MOV EAX, 0x92
0x7c90d765 ba               DB 0xba
0x7c90d766 0003             ADD [EBX], AL

Disassembly(1):
0x1da658f 58               POP EAX
0x1da6590 8d056663da01     LEA EAX, [0x1da6366]
0x1da6596 ffe0             JMP EAX
0x1da6598 c3               RET
0x1da6599 55               PUSH EBP
0x1da659a 8bec             MOV EBP, ESP
0x1da659c 51               PUSH ECX
0x1da659d 8365fc00         AND DWORD [EBP+0xfffffffc], 0x0
0x1da65a1 688f88d69b       PUSH DWORD 0x9bd6888f

...</code></pre>
</div></div>
<div class="paragraph"><p>Here is an example of using apihooks to detect the Inline hook of a kernel mode
function:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py apihooks -f rustock.vmem
************************************************************************
Hook mode: Kernelmode
Hook type: Inline/Trampoline
Victim module: ntoskrnl.exe (0x804d7000 - 0x806cf980)
Function: ntoskrnl.exe!IofCallDriver at 0x804ee130
Hook address: 0xb17a189d
Hooking module: &lt;unknown&gt;

Disassembly(0):
0x804ee130 ff2580c25480     JMP DWORD [0x8054c280]
0x804ee136 cc               INT 3
0x804ee137 cc               INT 3
0x804ee138 cc               INT 3
0x804ee139 cc               INT 3
0x804ee13a cc               INT 3
0x804ee13b cc               INT 3
0x804ee13c 8bff             MOV EDI, EDI
0x804ee13e 55               PUSH EBP
0x804ee13f 8bec             MOV EBP, ESP
0x804ee141 8b4d08           MOV ECX, [EBP+0x8]
0x804ee144 83f929           CMP ECX, 0x29
0x804ee147 72               DB 0x72

Disassembly(1):
0xb17a189d 56               PUSH ESI
0xb17a189e 57               PUSH EDI
0xb17a189f 8bf9             MOV EDI, ECX
0xb17a18a1 8b7708           MOV ESI, [EDI+0x8]
0xb17a18a4 3b35ab6d7ab1     CMP ESI, [0xb17a6dab]
0xb17a18aa 7509             JNZ 0xb17a18b5
0xb17a18ac 52               PUSH EDX
0xb17a18ad 57               PUSH EDI
0xb17a18ae e8c6430000       CALL 0xb17a5c79
0xb17a18b3 eb6a             JMP 0xb17a191f</code></pre>
</div></div>
<div class="paragraph"><p>Here is an example of using apihooks to detect the calls to an unknown code page
from a kernel driver. In this case, malware has patched tcpip.sys with some
malicious redirections.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f rustock-c.vmem apihooks
Volatile Systems Volatility Framework 2.1_alpha
************************************************************************
Hook mode: Kernelmode
Hook type: Unknown Code Page Call
Victim module: tcpip.sys (0xf7bac000 - 0xf7c04000)
Function: &lt;unknown&gt;
Hook address: 0x81ecd0c0
Hooking module: &lt;unknown&gt;

Disassembly(0):
0xf7be2514 ff15bcd0ec81     CALL DWORD [0x81ecd0bc]
0xf7be251a 817dfc03010000   CMP DWORD [EBP+0xfffffffc], 0x103
0xf7be2521 7506             JNZ 0xf7be2529
0xf7be2523 57               PUSH EDI
0xf7be2524 e8de860000       CALL 0xf7beac07
0xf7be2529 83               DB 0x83
0xf7be252a 66               DB 0x66
0xf7be252b 10               DB 0x10

Disassembly(1):
0x81ecd0c0 0e               PUSH CS
0x81ecd0c1 90               NOP
0x81ecd0c2 83ec04           SUB ESP, 0x4
0x81ecd0c5 c704246119c481   MOV DWORD [ESP], 0x81c41961
0x81ecd0cc cb               RETF

...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_idt">8.7. idt</h3>
<div class="paragraph"><p>To print the system&#8217;s IDT (Interrupt Descriptor Table), use the idt command. If
there are multiple processors on the system, the IDT for each individual CPU is
displayed. You&#8217;ll see the CPU number, the GDT selector, the current address and
owning module, and the name of the PE section in which the IDT function
resides. If you supply the --verbose parameter, a disassembly of the IDT
function will be shown.</p></div>
<div class="paragraph"><p>Some rootkits hook the IDT entry for KiSystemService, but point it at a routine
inside the NT module (where KiSystemService should point). However, at that
address, there is an Inline hook. The following output shows an example of how
Volatility can point this out for you. Notice how the 0x2E entry for
KiSystemService is in the .rsrc section of ntoskrnl.exe instead of .text like
all others.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f rustock.vmem idt
Volatile Systems Volatility Framework 2.1_alpha
   CPU  Index Selector Value      Module               Section
------ ------ -------- ---------- -------------------- ------------
     0      0        8 0x8053e1cc ntoskrnl.exe         .text
     0      1        8 0x8053e344 ntoskrnl.exe         .text
     0      2       88 0x00000000 ntoskrnl.exe
     0      3        8 0x8053e714 ntoskrnl.exe         .text
     0      4        8 0x8053e894 ntoskrnl.exe         .text
     0      5        8 0x8053e9f0 ntoskrnl.exe         .text
     0      6        8 0x8053eb64 ntoskrnl.exe         .text
     0      7        8 0x8053f1cc ntoskrnl.exe         .text
     0      8       80 0x00000000 ntoskrnl.exe
...
     0     2B        8 0x8053db10 ntoskrnl.exe         .text
     0     2C        8 0x8053dcb0 ntoskrnl.exe         .text
     0     2D        8 0x8053e5f0 ntoskrnl.exe         .text
     0     2E        8 0x806b01b8 ntoskrnl.exe         .rsrc
...</code></pre>
</div></div>
<div class="paragraph"><p>To get more details about the possible IDT modification, use --verbose:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f rustock.vmem idt --verbose
Volatile Systems Volatility Framework 2.1_alpha
   CPU  Index Selector Value      Module               Section
------ ------ -------- ---------- -------------------- ------------
...
     0     2E        8 0x806b01b8 ntoskrnl.exe         .rsrc
0x806b01b8 e95c2c0f31       JMP 0xb17a2e19
0x806b01bd e9832c0f31       JMP 0xb17a2e45
0x806b01c2 4e               DEC ESI
0x806b01c3 44               INC ESP
0x806b01c4 4c               DEC ESP
0x806b01c5 45               INC EBP
0x806b01c6 44               INC ESP
0x806b01c7 5f               POP EDI</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_gdt">8.8. gdt</h3>
<div class="paragraph"><p>To print the system&#8217;s GDT (Global Descriptor Table), use the gdt command. This
is useful for detecting rootkits like Alipop that install a call gate so that
user mode programs can call directly into kernel mode (using a CALL FAR
instruction).</p></div>
<div class="paragraph"><p>If your system has multiple CPUs, the GDT for each processor is shown.</p></div>
<div class="paragraph"><p>In the output below, you can see that selector 0x3e0 has been infected and used
for the purposes of a 32-bit call gate. The call gate address is 0x8003f000,
which is where execution continues.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f alipop.vmem gdt
Volatile Systems Volatility Framework 2.1_alpha
   CPU        Sel Base            Limit Type              DPL Gr   Pr
------ ---------- ---------- ---------- -------------- ------ ---- ----
     0        0x0 0x00ffdf0a     0xdbbb TSS16 Busy          2 By   P
     0        0x8 0x00000000 0xffffffff Code RE Ac          0 Pg   P
     0       0x10 0x00000000 0xffffffff Data RW Ac          0 Pg   P
     0       0x18 0x00000000 0xffffffff Code RE Ac          3 Pg   P
     0       0x20 0x00000000 0xffffffff Data RW Ac          3 Pg   P
     0       0x28 0x80042000     0x20ab TSS32 Busy          0 By   P
     0       0x30 0xffdff000     0x1fff Data RW Ac          0 Pg   P
     0       0x38 0x00000000      0xfff Data RW Ac          3 By   P
     0       0x40 0x00000400     0xffff Data RW             3 By   P
     0       0x48 0x00000000        0x0 &lt;Reserved&gt;          0 By   Np
...
     0      0x3d0 0x00008003     0xf3d8 &lt;Reserved&gt;          0 By   Np
     0      0x3d8 0x00008003     0xf3e0 &lt;Reserved&gt;          0 By   Np
     0      0x3e0 0x8003f000        0x0 CallGate32          3 -    P
     0      0x3e8 0x00000000 0xffffffff Code RE Ac          0 Pg   P
     0      0x3f0 0x00008003     0xf3f8 &lt;Reserved&gt;          0 By   Np
     0      0x3f8 0x00000000        0x0 &lt;Reserved&gt;          0 By   Np</code></pre>
</div></div>
<div class="paragraph"><p>If you want to further investigate the infection, you can break into a
<a href="#volshell">[volshell]</a> as shown below. Then disassemble code at the call gate address.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f alipop.vmem volshell
Volatile Systems Volatility Framework 2.1_alpha
Current context: process System, pid=4, ppid=0 DTB=0x320000
Welcome to volshell! Current memory image is:
file:///Users/Michael/Desktop/alipop.vmem
To get help, type 'hh()'

&gt;&gt;&gt; dis(0xffdf0adb, length=32)
0xffdf0adb c8000000                         ENTER 0x0, 0x0
0xffdf0adf 31c0                             XOR EAX, EAX
0xffdf0ae1 60                               PUSHA
0xffdf0ae2 8b5508                           MOV EDX, [EBP+0x8]
0xffdf0ae5 bb00704d80                       MOV EBX, 0x804d7000
0xffdf0aea 8b4b3c                           MOV ECX, [EBX+0x3c]
0xffdf0aed 8b6c0b78                         MOV EBP, [EBX+ECX+0x78]

&gt;&gt;&gt; db(0xffdf0adb + 75, length = 512)
ffdf0b26   d9 03 1c 81 89 5c 24 1c 61 c9 c2 04 00 7e 00 80    ......$.a....~..
ffdf0b36   00 3b 0b df ff 5c 00 52 00 65 00 67 00 69 00 73    .;.....R.e.g.i.s
ffdf0b46   00 74 00 72 00 79 00 5c 00 4d 00 61 00 63 00 68    .t.r.y...M.a.c.h
ffdf0b56   00 69 00 6e 00 65 00 5c 00 53 00 4f 00 46 00 54    .i.n.e...S.O.F.T
ffdf0b66   00 57 00 41 00 52 00 45 00 5c 00 4d 00 69 00 63    .W.A.R.E...M.i.c
ffdf0b76   00 72 00 6f 00 73 00 6f 00 66 00 74 00 5c 00 57    .r.o.s.o.f.t...W
ffdf0b86   00 69 00 6e 00 64 00 6f 00 77 00 73 00 5c 00 43    .i.n.d.o.w.s...C
ffdf0b96   00 75 00 72 00 72 00 65 00 6e 00 74 00 56 00 65    .u.r.r.e.n.t.V.e
ffdf0ba6   00 72 00 73 00 69 00 6f 00 6e 00 5c 00 52 00 75    .r.s.i.o.n...R.u
ffdf0bb6   00 6e 00 00 00 06 00 08 00 c3 0b df ff 71 00 51    .n...........q.Q
ffdf0bc6   00 00 00 43 00 3a 00 5c 00 57 00 49 00 4e 00 44    ...C.:...W.I.N.D
ffdf0bd6   00 4f 00 57 00 53 00 5c 00 61 00 6c 00 69 00 2e    .O.W.S...a.l.i..
ffdf0be6   00 65 00 78 00 65 00 00 00 26 00 28 00 f7 0b df    .e.x.e...&amp;.(....
ffdf0bf6   ff 5c 00 53 00 79 00 73 00 74 00 65 00 6d 00 52    ...S.y.s.t.e.m.R
ffdf0c06   00 6f 00 6f 00 74 00 5c 00 61 00 6c 00 69 00 2e    .o.o.t...a.l.i..
ffdf0c16   00 65 00 78 00 65 00 00 00 00 00 e8 03 00 ec 00    .e.x.e..........
ffdf0c26   00 ff ff 00 00 00 9a cf 00 4d 5a 90 00 03 00 00    .........MZ.....
ffdf0c36   00 04 00 00 00 ff ff 00 00 b8 00 00 00 00 00 00    ................
ffdf0c46   00 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00    .@..............
ffdf0c56   00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
ffdf0c66   00 00 00 00 00 e0 00 00 00 0e 1f ba 0e 00 b4 09    ................
ffdf0c76   cd 21 b8 01 4c cd 21 54 68 69 73 20 70 72 6f 67    .!..L.!This prog
ffdf0c86   72 61 6d 20 63 61 6e 6e 6f 74 20 62 65 20 72 75    ram cannot be ru
ffdf0c96   6e 20 69 6e 20 44 4f 53 20 6d 6f 64 65 2e 0d 0d    n in DOS mode...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_threads">8.9. threads</h3>
<div class="paragraph"><p>The command gives you extensive details on threads, including the contents of
each thread&#8217;s registers (if available), a disassembly of code at the thread&#8217;s
start address, and various other fields that may be relevant to an
investigation. Since any given system has hundreds of threads, making it
difficult to sort through, this command associates descriptive tags to the
threads it finds - and then you can filter by tag name with the -F or --filter
parameter.</p></div>
<div class="paragraph"><p>To see a list of available tags/filters, use -L like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f test.vmem threads -L
Volatile Systems Volatility Framework 2.1_alpha
Tag                  Description
--------------       --------------
DkomExit             Detect inconsistencies wrt exit times and termination
HwBreakpoints        Detect threads with hardware breakpoints
ScannerOnly          Detect threads no longer in a linked list
HideFromDebug        Detect threads hidden from debuggers
OrphanThread         Detect orphan threads
AttachedProcess      Detect threads attached to another process
HookedSSDT           Detect threads using a hooked SSDT
SystemThread         Detect system threads</code></pre>
</div></div>
<div class="paragraph"><p>If you don&#8217;t specify any filters, then the command will output information on
all threads. Otherwise, you can specify a single filter or multiple filters
separated by commas. Here is an example of hunting for threads that are
currently executing in the context of a process other than the process which
owns the thread:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   $ python vol.py -f XPSP3.vmem threads -F AttachedProcess
   Volatile Systems Volatility Framework 2.1_alpha
   ------
   ETHREAD: 0x81eda7a0 Pid: 4 Tid: 484
   Tags: SystemThread,AttachedProcess,HookedSSDT
   Created: 2011-04-18 16:03:38
   Exited: -
   Owning Process: 0x823c8830 System
   Attached Process: 0x81e3c458 services.exe
   State: Running
   BasePriority: THREAD_PRIORITY_NORMAL
   TEB: 0x00000000
   StartAddress: 0xb1805f1a windev-5e93-fd3.sys
   ServiceTable: 0x80553020
   [0] 0x80501bbc
   [0x47] NtEnumerateKey 0xb1805944 windev-5e93-fd3.sys
   [0x49] NtEnumerateValueKey 0xb1805aca windev-5e93-fd3.sys
   [0x91] NtQueryDirectoryFile 0xb18055ee windev-5e93-fd3.sys
   [1] -
   [2] -
   [3] -
   Win32Thread: 0x00000000
   CrossThreadFlags: PS_CROSS_THREAD_FLAGS_SYSTEM
   b1805f1a: 8bff                         MOV EDI, EDI
   b1805f1c: 55                           PUSH EBP
   b1805f1d: 8bec                         MOV EBP, ESP
   b1805f1f: 51                           PUSH ECX
   b1805f20: 51                           PUSH ECX</code></pre>
</div></div>
<div class="paragraph"><p>First, you see the virtual address of the ETHREAD object along with the process
ID and thread ID. Next you see all tags associated with the thread
(SystemThread, AttachedProcess, !HookedSSDT), the creation/exit times, state,
priority, start address, etc. It shows the SSDT base along with the address of
each service table and any hooked functions in the tables. Finally, you see a
disassembly of the thread&#8217;s start address.</p></div>
<div class="paragraph"><p>For a detailed description of each tag/filter and instructions on how to add
your own heuristics to the threads command, see Investigating Windows Threads
with Volatility.</p></div>
<div class="paragraph"><p>Note: with the introduction of this command, two older commands (orphan_threads
and ssdt_by_threads) have been deprecated.</p></div>
</div>
<div class="sect2">
<h3 id="_callbacks">8.10. callbacks</h3>
<div class="paragraph"><p>Volatility is the only memory forensics platform with the ability to print an
assortment of important notification routines and kernel callbacks. Rootkits,
anti-virus suites, dynamic analysis tools (such as Sysinternals' Process Monitor
and Tcpview), and many components of the Windows kernel use of these callbacks
to monitor and/or react to events. We detect the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>PsSetCreateProcessNotifyRoutine (process creation).
PsSetCreateThreadNotifyRoutine (thread creation).
PsSetImageLoadNotifyRoutine (DLL/image load).
IoRegisterFsRegistrationChange (file system registration).
KeRegisterBugCheck and KeRegisterBugCheckReasonCallback.
CmRegisterCallback (registry callbacks on XP).
CmRegisterCallbackEx (registry callbacks on Vista and 7).
IoRegisterShutdownNotification (shutdown callbacks).
DbgSetDebugPrintCallback (debug print callbacks on Vista and 7).
DbgkLkmdRegisterCallback (debug callbacks on 7).</code></pre>
</div></div>
<div class="paragraph"><p>Here&#8217;s an example of detecting the thread creation callback installed by the
BlackEnergy 2 malware. You can spot the malicious callback because the owner is
00004A2A - and BlackEnergy 2 uses a module name composed of eight hex
characters.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f be2.vmem callbacks
Volatile Systems Volatility Framework 2.1_alpha
Type                                 Callback   Owner
PsSetCreateThreadNotifyRoutine       0xff0d2ea7 00004A2A
PsSetCreateProcessNotifyRoutine      0xfc58e194 vmci.sys
KeBugCheckCallbackListHead           0xfc1e85ed NDIS.sys (Ndis miniport)
KeBugCheckCallbackListHead           0x806d57ca hal.dll (ACPI 1.0 - APIC platform UP)
KeRegisterBugCheckReasonCallback     0xfc967ac0 mssmbios.sys (SMBiosData)
KeRegisterBugCheckReasonCallback     0xfc967a78 mssmbios.sys (SMBiosRegistry)
...</code></pre>
</div></div>
<div class="paragraph"><p>Here is an example of detecting the malicious process creation callback
installed by the Rustock rootkit (points to memory owned by \Driver\pe386).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f rustock.vmem callbacks
Volatile Systems Volatility Framework 2.1_alpha
Type                                 Callback   Owner
PsSetCreateProcessNotifyRoutine      0xf88bd194 vmci.sys
PsSetCreateProcessNotifyRoutine      0xb17a27ed '\\Driver\\pe386'
KeBugCheckCallbackListHead           0xf83e65ef NDIS.sys (Ndis miniport)
KeBugCheckCallbackListHead           0x806d77cc hal.dll (ACPI 1.0 - APIC platform UP)
KeRegisterBugCheckReasonCallback     0xf8b7aab8 mssmbios.sys (SMBiosData)
KeRegisterBugCheckReasonCallback     0xf8b7aa70 mssmbios.sys (SMBiosRegistry)
KeRegisterBugCheckReasonCallback     0xf8b7aa28 mssmbios.sys (SMBiosDataACPI)
KeRegisterBugCheckReasonCallback     0xf76201be USBPORT.SYS (USBPORT)
KeRegisterBugCheckReasonCallback     0xf762011e USBPORT.SYS (USBPORT)
KeRegisterBugCheckReasonCallback     0xf7637522 VIDEOPRT.SYS (Videoprt)
...</code></pre>
</div></div>
<div class="paragraph"><p>Here is an example of detecting the malicious registry change callback installed
by the Ascesso rootkit. There is one CmRegisterCallback pointing to 0x8216628f
which does not have an owner. You also see two GenericKernelCallback with the
same address. This is because notifyroutines finds callbacks in multiple
ways. It combines list traversal and pool tag scanning. This way, if the list
traversal fails, we can still find information with pool tag scanning. However,
the Windows kernel uses the same types of pool tags for various callbacks, so we
label those as generic.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f ascesso.vmem callbacks
Volatile Systems Volatility Framework 2.1_alpha
Type                                 Callback   Owner
IoRegisterShutdownNotification       0xf853c2be ftdisk.sys (\Driver\Ftdisk)
IoRegisterShutdownNotification       0x805f5d66 ntoskrnl.exe (\Driver\WMIxWDM)
IoRegisterShutdownNotification       0xf83d98f1 Mup.sys (\FileSystem\Mup)
IoRegisterShutdownNotification       0xf86aa73a MountMgr.sys (\Driver\MountMgr)
IoRegisterShutdownNotification       0x805cdef4 ntoskrnl.exe (\FileSystem\RAW)
CmRegisterCallback                   0x8216628f UNKNOWN (--)
GenericKernelCallback                0xf888d194 vmci.sys
GenericKernelCallback                0x8216628f UNKNOWN
GenericKernelCallback                0x8216628f UNKNOWN</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_driverirp">8.11. driverirp</h3>
<div class="paragraph"><p>To print a driver&#8217;s IRP (Major Function) table, use the driverirp command. This
command inherits from driverscan so that its able to locate DRIVER_OBJECTs. Then
it cycles through the function table, printing the purpose of each function, the
function&#8217;s address, and the owning module of the address.</p></div>
<div class="paragraph"><p>Many drivers forward their IRP functions to other drivers for legitimate
purposes, so detecting hooked IRP functions based on containing modules is not a
good method. Instead, we print everything and let you be the judge. The command
also checks for Inline hooks of IRP functions and optionally prints a
disassembly of the instructions at the IRP address (pass -v or --verbose to
enable this).</p></div>
<div class="paragraph"><p>This command outputs information for all drivers, unless you specify a regular
expression filter.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   $ python vol.py -f tdl3.vmem driverirp -r vmscsi
   Volatile Systems Volatility Framework 2.1_alpha
   --------------------------------------------------
   DriverName: vmscsi
   DriverStart: 0xf9db8000
   DriverSize: 0x2c00
   DriverStartIo: 0xf97ea40e
      0 IRP_MJ_CREATE                        0xf9db9cbd vmscsi.sys
      1 IRP_MJ_CREATE_NAMED_PIPE             0xf9db9cbd vmscsi.sys
      2 IRP_MJ_CLOSE                         0xf9db9cbd vmscsi.sys
      3 IRP_MJ_READ                          0xf9db9cbd vmscsi.sys
      4 IRP_MJ_WRITE                         0xf9db9cbd vmscsi.sys
      5 IRP_MJ_QUERY_INFORMATION             0xf9db9cbd vmscsi.sys
      6 IRP_MJ_SET_INFORMATION               0xf9db9cbd vmscsi.sys
      7 IRP_MJ_QUERY_EA                      0xf9db9cbd vmscsi.sys
   ...</code></pre>
</div></div>
<div class="paragraph"><p>In the output, it is not apparent that the vmscsi.sys driver has been infected
by the TDL3 rootkit. Although all IRPs point back into vmscsi.sys, they point at
a stub staged in that region by TDL3 for the exact purpose of bypassing rootkit
detection tools. To get extended information, use --verbose:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>   $ python vol.py -f tdl3.vmem driverirp -r vmscsi --verbose
   Volatile Systems Volatility Framework 2.1_alpha
   --------------------------------------------------
   DriverName: vmscsi
   DriverStart: 0xf9db8000
   DriverSize: 0x2c00
   DriverStartIo: 0xf97ea40e
      0 IRP_MJ_CREATE                        0xf9db9cbd vmscsi.sys

   0xf9db9cbd a10803dfff       MOV EAX, [0xffdf0308]
   0xf9db9cc2 ffa0fc000000     JMP DWORD [EAX+0xfc]
   0xf9db9cc8 0000             ADD [EAX], AL
   0xf9db9cca 0000             ADD [EAX], AL

      1 IRP_MJ_CREATE_NAMED_PIPE             0xf9db9cbd vmscsi.sys
   0xf9db9cbd a10803dfff       MOV EAX, [0xffdf0308]
   0xf9db9cc2 ffa0fc000000     JMP DWORD [EAX+0xfc]
   0xf9db9cc8 0000             ADD [EAX], AL
   0xf9db9cca 0000             ADD [EAX], AL

   ...</code></pre>
</div></div>
<div class="paragraph"><p>Now you can see that TDL3 redirects all IRPs to its own stub in the vmscsi.sys
driver. That code jumps to whichever address is pointed to by 0xffdf0308 - a
location in the KUSER_SHARED_DATA region.</p></div>
</div>
<div class="sect2">
<h3 id="_devicetree">8.12. devicetree</h3>
<div class="paragraph"><p>Windows uses a layered driver architecture, or driver chain so that multiple
drivers can inspect or respond to an IRP. Rootkits often insert drivers (or
devices) into this chain for filtering purposes (to hide files, hide network
connections, steal keystrokes or mouse movements). The devicetree plugin shows
the relationship of a driver object to its devices (by walking
_DRIVER_OBJECT.DeviceObject.NextDevice) and any attached devices
(_DRIVER_OBJECT.DeviceObject.AttachedDevice).</p></div>
<div class="paragraph"><p>In the example below, Stuxnet has infected \FileSystem?\Ntfs by attaching a
malicious unnamed device. Although the device itself is unnamed, the device
object identifies its driver (\Driver\MRxNet).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f stuxnet.vmem devicetree
Volatile Systems Volatility Framework 2.1_alpha
...
DRV 0x0253d180 '\\FileSystem\\Ntfs'
---| DEV 0x82166020 (unnamed) FILE_DEVICE_DISK_FILE_SYSTEM
------| ATT 0x8228c6b0 (unnamed) - '\\FileSystem\\sr' FILE_DEVICE_DISK_FILE_SYSTEM
---------| ATT 0x81f47020 (unnamed) - '\\FileSystem\\FltMgr' FILE_DEVICE_DISK_FILE_SYSTEM
------------| ATT 0x81fb9680 (unnamed) - '\\Driver\\MRxNet' FILE_DEVICE_DISK_FILE_SYSTEM
---| DEV 0x8224f790 Ntfs FILE_DEVICE_DISK_FILE_SYSTEM
------| ATT 0x81eecdd0 (unnamed) - '\\FileSystem\\sr' FILE_DEVICE_DISK_FILE_SYSTEM
---------| ATT 0x81e859c8 (unnamed) - '\\FileSystem\\FltMgr' FILE_DEVICE_DISK_FILE_SYSTEM
------------| ATT 0x81f0ab90 (unnamed) - '\\Driver\\MRxNet' FILE_DEVICE_DISK_FILE_SYSTEM
...</code></pre>
</div></div>
<div class="paragraph"><p>The devicetree plugin uses "DRV" to indicate drivers, "DEV" to indicate devices,
and "ATT" to indicate attached devices (just like OSR&#8217;s DeviceTree utility).</p></div>
<div class="paragraph"><p>The x64 version looks very similar:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ /usr/bin/python2.6 vol.py -f ~/Desktop/win7_trial_64bit.raw --profile=Win7SP0x64 \
  devicetreeVolatile Systems Volatility Framework 2.1_alpha
DRV 0x174c6350 \Driver\mouhid
---| DEV 0xfffffa8000dfbc90  FILE_DEVICE_MOUSE
------| ATT 0xfffffa8000ec7060  - \Driver\mouclass FILE_DEVICE_MOUSE
DRV 0x17660cb0 \Driver\rspndr
---| DEV 0xfffffa80005a1c20 rspndr FILE_DEVICE_NETWORK
DRV 0x17663e70 \Driver\lltdio
---| DEV 0xfffffa8000c78b70 lltdio FILE_DEVICE_NETWORK
DRV 0x17691d70 \Driver\cdrom
---| DEV 0xfffffa8000d00060 CdRom0 FILE_DEVICE_CD_ROM
DRV 0x176a7280 \FileSystem\Msfs
---| DEV 0xfffffa8000cac060 Mailslot FILE_DEVICE_MAILSLOT
DRV 0x176ac6f0 \FileSystem\Npfs
---| DEV 0xfffffa8000cac320 NamedPipe FILE_DEVICE_NAMED_PIPE
DRV 0x176ade70 \Driver\tdx
---| DEV 0xfffffa8000cb8c00 RawIp6 FILE_DEVICE_NETWORK
---| DEV 0xfffffa8000cb8e30 RawIp FILE_DEVICE_NETWORK
---| DEV 0xfffffa8000cb7510 Udp6 FILE_DEVICE_NETWORK
---| DEV 0xfffffa8000cb7740 Udp FILE_DEVICE_NETWORK
---| DEV 0xfffffa8000cb7060 Tcp6 FILE_DEVICE_NETWORK
---| DEV 0xfffffa8000cad140 Tcp FILE_DEVICE_NETWORK
---| DEV 0xfffffa8000cadbb0 Tdx FILE_DEVICE_TRANSPORT
DRV 0x176ae350 \Driver\Psched
---| DEV 0xfffffa8000cc4590 Psched FILE_DEVICE_NETWORK
DRV 0x176aee70 \Driver\WfpLwf
DRV 0x176b93a0 \Driver\AFD
---| DEV 0xfffffa8000cb9180 Afd FILE_DEVICE_NAMED_PIPE
DRV 0x176c28a0 \Driver\NetBT
---| DEV 0xfffffa8000db4060 NetBT_Tcpip_{EE0434CC-82D1-47EA-B5EB-AF721863ACC2} FILE_DEVICE_NETWORK
---| DEV 0xfffffa8000c1d8f0 NetBt_Wins_Export FILE_DEVICE_NETWORK
DRV 0x176c3930 \FileSystem\NetBIOS
---| DEV 0xfffffa8000cc3680 Netbios FILE_DEVICE_TRANSPORT
...</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_psxview">8.13. psxview</h3>
<div class="paragraph"><p>This plugin helps you detect hidden processes by comparing what
PsActiveProcessHead contains with what is reported by various other sources of
process listings. It compares the following:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
PsActiveProcessHead linked list
</p>
</li>
<li>
<p>
EPROCESS pool scanning
</p>
</li>
<li>
<p>
ETHREAD pool scanning (then it references the owning EPROCESS)
</p>
</li>
<li>
<p>
PspCidTable
</p>
</li>
<li>
<p>
Csrss.exe handle table
</p>
</li>
<li>
<p>
Csrss.exe internal linked list
</p>
</li>
</ol></div>
<div class="paragraph"><p>On Windows Vista and Windows 7 the internal list of processes in csrss.exe is
not available. It also may not be available in some XP images where certain
pages are not memory resident.</p></div>
<div class="paragraph"><p>Here is an example of detecting the Prolaco malware with psxview. A "False" in
any column indicates that the respective process is missing. You can tell
"1_doc_RCData_61" is suspicious since it shows up in every column except pslist
(PsActiveProcessHead).</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f prolaco.vmem psxview
Volatile Systems Volatility Framework 2.1_alpha
Offset(P)  Name                    PID pslist psscan thrdproc pspcdid csrss
---------- -------------------- ------ ------ ------ -------- ------- -----
0x06499b80 svchost.exe            1148 True   True   True     True    True
0x04b5a980 VMwareUser.exe          452 True   True   True     True    True
0x0655fc88 VMUpgradeHelper        1788 True   True   True     True    True
0x0211ab28 TPAutoConnSvc.e        1968 True   True   True     True    True
0x04c2b310 wscntfy.exe             888 True   True   True     True    True
0x061ef558 svchost.exe            1088 True   True   True     True    True
0x06945da0 spoolsv.exe            1432 True   True   True     True    True
0x05471020 smss.exe                544 True   True   True     True    False
0x04a544b0 ImmunityDebugge        1136 True   True   True     True    True
0x069d5b28 vmtoolsd.exe           1668 True   True   True     True    True
0x06384230 vmacthlp.exe            844 True   True   True     True    True
0x010f7588 wuauclt.exe             468 True   True   True     True    True
0x066f0da0 csrss.exe               608 True   True   True     True    False
0x05f027e0 alg.exe                 216 True   True   True     True    True
0x06015020 services.exe            676 True   True   True     True    True
0x04a065d0 explorer.exe           1724 True   True   True     True    True
0x049c15f8 TPAutoConnect.e        1084 True   True   True     True    True
0x0115b8d8 svchost.exe             856 True   True   True     True    True
0x01214660 System                    4 True   True   True     True    False
0x01122910 svchost.exe            1028 True   True   True     True    True
0x04be97e8 VMwareTray.exe          432 True   True   True     True    True
0x05f47020 lsass.exe               688 True   True   True     True    True
0x063c5560 svchost.exe             936 True   True   True     True    True
0x066f0978 winlogon.exe            632 True   True   True     True    True
0x0640ac10 msiexec.exe            1144 False  True   False    False   False
0x005f23a0 rundll32.exe           1260 False  True   False    False   False
0x0113f648 1_doc_RCData_61        1336 False  True   True     True    True</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_timers">8.14. timers</h3>
<div class="paragraph"><p>This command prints installed kernel timers (KTIMER) and any associated DPCs
(Deferred Procedure Calls). Rootkits such as Zero Access, Rustock, and Stuxnet
register timers with a DPC. Although the malware tries to be stealthy and hide
in kernel space in a number of different ways, by finding the KTIMERs and
looking at the address of the DPC, you can quickly find the malicious code
ranges.</p></div>
<div class="paragraph"><p>Here&#8217;s an example. Notice how one of the timers has an UNKNOWN module (the DPC
points to an unknown region of kernel memory). This is ultimately where the
rootkit is hiding.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python vol.py -f rustock-c.vmem timers
Volatile Systems Volatility Framework 2.1_alpha
Offset(V)  DueTime                  Period(ms) Signaled   Routine    Module
---------- ------------------------ ---------- ---------- ---------- ------
0xf730a790 0x00000000:0x6db0f0b4             0 -          0xf72fb385 srv.sys
0x80558a40 0x00000000:0x68f10168          1000 Yes        0x80523026 ntoskrnl.exe
0x821cb240 0x00000000:0x68fa8ad0             0 -          0xf84b392e sr.sys
0x8054f288 0x00000000:0x69067692             0 -          0x804e5aec ntoskrnl.exe
0xf7c13fa0 0x00000000:0x74f6fd46         60000 Yes        0xf7c044d3 ipsec.sys
0xf7c13b08 0x00000000:0x74f6fd46             0 -          0xf7c04449 ipsec.sys
0x8055a300 0x00000008:0x61e82b46             0 -          0x80533bf8 ntoskrnl.exe
0xf7c13b70 0x00000008:0x6b719346             0 -          0xf7c04449 ipsec.sys
0xf7befbf0 0x00000000:0x690d9da0             0 -          0xf89aa3f0 TDI.SYS
0x81ea5ee8 0x00000000:0x7036f590             0 -          0x80534016 ntoskrnl.exe
0x81d69180 0x80000000:0x3ae334ee             0 -          0x80534016 ntoskrnl.exe
0xf70d0040 0x00000000:0x703bd2ae             0 -          0xf70c3ae8 HTTP.sys
0xf7a74260 0x00000000:0x75113724         60000 Yes        0xf7a6cf98 ipnat.sys
0x82012e08 0x00000000:0x8a87d2d2             0 -          0xf832653c ks.sys
0x81f01358 0x00000008:0x6b97b8e6             0 -          0xf7b8448a netbt.sys
0x81f41218 0x00000000:0x6933c340             0 -          0xf7b8448a netbt.sys
0x805508d0 0x00000000:0x6ba6cdb6         60000 Yes        0x804f3b72 ntoskrnl.exe
0x80559160 0x00000000:0x695c4b3a             0 -          0x80526bac ntoskrnl.exe
0x820822e4 0x00000000:0xa2a56bb0        150000 Yes        0x81c1642f UNKNOWN
0xf842f150 0x00000000:0xb5cb4e80             0 -          0xf841473e Ntfs.sys
0x821811b0 0x00000131:0x34c6cb8e             0 -          0xf83fafdf NDIS.sys
...</code></pre>
</div></div>
<div class="paragraph"><p>Please note: the timers are enumerated in different ways depending on the target
operating system. Windows stores the timers in global variables for XP, 2003,
2008, and Vista. Since Windows 7, the timers are are in processor-specific
regions off of KPCR (Kernel Processor Control Region). As of Volatility 2.1, if
there are multiple CPUs, the timers plugin finds all KPCRs and prints the timers
associated with each CPU.</p></div>
<div class="paragraph"><p>For more information on timer objects, see Ain&#8217;t Nuthin But a K(Timer) Thing,
Baby.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_win32k_gui">9. Win32k / GUI</h2>
<div class="sectionbody">
<div class="paragraph"><p>TBD</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2012-10-06 02:15:18 CEST
</div>
</div>
</body>
</html>
